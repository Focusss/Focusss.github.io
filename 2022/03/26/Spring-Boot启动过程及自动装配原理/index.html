<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta name="description" content="Spring Boot自动装配依赖@SpringBootApplication注解，该注解对应由@SpringBootConfiguration、@EnableAutoConfiguration、@ComponentScan组成">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Boot启动过程及自动装配原理">
<meta property="og:url" content="https://focusss.github.io/2022/03/26/Spring-Boot%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%8F%8A%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E5%8E%9F%E7%90%86/index.html">
<meta property="og:site_name" content="大 湾 区 码 仔&#39;s Blog">
<meta property="og:description" content="Spring Boot自动装配依赖@SpringBootApplication注解，该注解对应由@SpringBootConfiguration、@EnableAutoConfiguration、@ComponentScan组成">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://focusss.github.io/2022/03/26/Spring-Boot%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%8F%8A%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E5%8E%9F%E7%90%86/SpringBootApplication%E6%B3%A8%E8%A7%A3.png">
<meta property="og:image" content="https://focusss.github.io/2022/03/26/Spring-Boot%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%8F%8A%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E5%8E%9F%E7%90%86/EnableAutoConfiguration.png">
<meta property="og:image" content="https://focusss.github.io/2022/03/26/Spring-Boot%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%8F%8A%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E5%8E%9F%E7%90%86/%E5%90%AF%E5%8A%A8%E7%B1%BBListener%E5%92%8CInitializer.png">
<meta property="og:image" content="https://focusss.github.io/2022/03/26/Spring-Boot%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%8F%8A%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E5%8E%9F%E7%90%86/SpringApplicationRunListener.png">
<meta property="og:image" content="https://focusss.github.io/2022/03/26/Spring-Boot%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%8F%8A%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E5%8E%9F%E7%90%86/SpringApplicationListener.png">
<meta property="og:image" content="https://focusss.github.io/2022/03/26/Spring-Boot%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%8F%8A%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E5%8E%9F%E7%90%86/AnnotationConfigServletWebServerApplicationContext.png">
<meta property="og:image" content="https://focusss.github.io/2022/03/26/Spring-Boot%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%8F%8A%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E5%8E%9F%E7%90%86/processConfigBeanDefinitions.jpg">
<meta property="og:image" content="https://focusss.github.io/2022/03/26/Spring-Boot%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%8F%8A%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E5%8E%9F%E7%90%86/refresh.jpg">
<meta property="article:published_time" content="2022-03-26T05:23:01.000Z">
<meta property="article:modified_time" content="2022-03-30T01:30:26.015Z">
<meta property="article:author" content="大湾区码仔驰名商标">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="SPI">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://focusss.github.io/2022/03/26/Spring-Boot%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%8F%8A%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E5%8E%9F%E7%90%86/SpringBootApplication%E6%B3%A8%E8%A7%A3.png"><title>Spring Boot启动过程及自动装配原理 | 大 湾 区 码 仔's Blog</title><link ref="canonical" href="https://focusss.github.io/2022/03/26/Spring-Boot%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%8F%8A%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E5%8E%9F%E7%90%86/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: true,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: true,
  pjax: {"avoidBanner":false},
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">大 湾 区 码 仔's Blog</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">Spring Boot启动过程及自动装配原理</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2022-03-26</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2022-03-30</span></span><span class="post-meta-item post-meta-item--visitors"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">阅读次数</span><span class="post-meta-item__value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body">
        <h3 id="简述">
          <a href="#简述" class="heading-link"><i class="fas fa-link"></i></a><a href="#简述" class="headerlink" title="简述"></a>简述</h3>
      <p>Spring Boot相对Spring的优点主要有两个:</p>
<ul>
<li>起步依赖-会将很多jar包按照功能合并成stater整体进行版本管理和引用，解决Spring集成其他框架时jar版本管理问题</li>
<li>自动装配-引入相关的jar包后SpringBoot会自动注册一些比较关键的bean，并进行默认配置，不用我们进行特殊配置，解决Spring重量级XML配置问题。比如整合Mybatis时的SqlSessionFactory</li>
</ul>
<p>SpringBoot启动依靠的是带有main方法的启动类，启动类的内容可以分为两个部分一个是启动类上@SpringBootApplication这个注解；第二部分是main方法里的SpringApplication.run(启动类.class，args)方法。下面探讨的内容是基于<code>Spring Boot 2.1.7-RELEASE</code>版本。</p>

        <h3 id="Spring-Boot自动装配原理（从注解-SpringBootApplication入手）">
          <a href="#Spring-Boot自动装配原理（从注解-SpringBootApplication入手）" class="heading-link"><i class="fas fa-link"></i></a><a href="#Spring-Boot自动装配原理（从注解-SpringBootApplication入手）" class="headerlink" title="Spring Boot自动装配原理（从注解@SpringBootApplication入手）"></a>Spring Boot自动装配原理（从注解@SpringBootApplication入手）</h3>
      <p>@SpringBootApplication是个组合注解包含四个元注解和<b>@SpringBootConfiguration</b>、<b>@EnableAutoConfiguration</b>、<b>@ComponentScan</b>组成，下面逐个分析。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span> <span class="comment">// 注解的适用范围，其中TYPE用于描述类、接口（包括包注解类型）或enum声明</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span> <span class="comment">// 注解的生命周期，Runtime运行时</span></span><br><span class="line"><span class="meta">@Documented</span> <span class="comment">// 表明这个注解应该被javadoc记录</span></span><br><span class="line"><span class="meta">@Inherited</span> <span class="comment">// 子类可以继承该注解</span></span><br><span class="line"><span class="comment">//上面为元注解</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span> <span class="comment">// 继承了Configuration，表示当前是配置类</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span> <span class="comment">// 启动自动配置功能，springboot的四大神器之一，其借助@import的帮助</span></span><br><span class="line"><span class="meta">@ComponentScan(excludeFilters = &#123; // 扫描路径设置 启动类所在包及子包下的类</span></span><br><span class="line"><span class="meta">@Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span></span><br><span class="line"><span class="meta">@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span><br><span class="line">...</span><br><span class="line">&#125;　</span><br></pre></td></tr></table></div></figure>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="SpringBootApplication%E6%B3%A8%E8%A7%A3.png">
      </p>

        <h4 id="SpringBootConfiguration">
          <a href="#SpringBootConfiguration" class="heading-link"><i class="fas fa-link"></i></a><a href="#SpringBootConfiguration" class="headerlink" title="@SpringBootConfiguration"></a>@SpringBootConfiguration</h4>
      <p><code>@SpringBootConfiguration</code>也是一个组合注解，由元注解和<code>@Configuration</code>构成。<code>@Configuration</code>是<code>@Component</code>的一个衍生注解主要作用是标记当前类是个配置类。<br><code>@SpringBootConfiguration</code>注解类代码如下：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootConfiguration &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><code>@Configuration</code>注解类代码如下：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Configuration &#123;</span><br><span class="line">    <span class="meta">@AliasFor(</span></span><br><span class="line"><span class="meta">        annotation = Component.class</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>


        <h4 id="EnableAutoConfiguration">
          <a href="#EnableAutoConfiguration" class="heading-link"><i class="fas fa-link"></i></a><a href="#EnableAutoConfiguration" class="headerlink" title="@EnableAutoConfiguration"></a>@EnableAutoConfiguration</h4>
      <p><code>@EnableAutoConfiguration</code>也是一个组合注解由元注解和<code>@AutoConfigurationPackage</code>、<code>@Import</code>注解构成，Spring中有很多Enable开头的注解，其作用大都是借助<code>@Import</code>来收集并注册特定场景相关的bean。<br><code>@EnableAutoConfiguration</code>的主要作用就是借助<code>@Import</code>来收集并注册所有符合自动装配条件的bean。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="comment">//注册BasePackages类到Spring容器，在整合jpa时会用到，非这次讲解的重点</span></span><br><span class="line"><span class="meta">@AutoConfigurationPackage</span></span><br><span class="line"><span class="comment">//将所有符合条件的@Configuration配置都加载到SpringBoot创建的IOC容器中（ApplicationContext）</span></span><br><span class="line"><span class="meta">@Import(&#123;AutoConfigurationImportSelector.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfiguration &#123;</span><br><span class="line">    String ENABLED_OVERRIDE_PROPERTY = <span class="string">&quot;spring.boot.enableautoconfiguration&quot;</span>;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt;[] exclude() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    String[] excludeName() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

        <h5 id="AutoConfigurationPackage">
          <a href="#AutoConfigurationPackage" class="heading-link"><i class="fas fa-link"></i></a><a href="#AutoConfigurationPackage" class="headerlink" title="@AutoConfigurationPackage"></a>@AutoConfigurationPackage</h5>
      <p><code>@SpringBootApplication</code>扫描启动类当前包及其子包下面的类是由下文的<code>@ComponentScan</code>注解完成的。非<code>@AutoConfigurationPackage</code>注解完成的。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="comment">//给容器中导入某个组件类，现在是将Registrar这个组件类导入到容器中</span></span><br><span class="line"><span class="meta">@Import(&#123;Registrar.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AutoConfigurationPackage &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>Registrar.class实现了ImportBeanDefinitionRegistrar接口会调用registerBeanDefinitions方法。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Registrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span>, <span class="title">DeterminableImports</span> </span>&#123;</span><br><span class="line">        Registrar() &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取的是项目主程序启动类所在的目录</span></span><br><span class="line">        <span class="comment">//metadata:注解标注的元数据信息	</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">            AutoConfigurationPackages.register(registry, (<span class="keyword">new</span> AutoConfigurationPackages.PackageImport(metadata)).getPackageName());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Set&lt;Object&gt; <span class="title">determineImports</span><span class="params">(AnnotationMetadata metadata)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.singleton(<span class="keyword">new</span> AutoConfigurationPackages.PackageImport(metadata));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

        <h5 id="Import-AutoConfigurationImportSelector-class">
          <a href="#Import-AutoConfigurationImportSelector-class" class="heading-link"><i class="fas fa-link"></i></a><a href="#Import-AutoConfigurationImportSelector-class" class="headerlink" title="@Import({AutoConfigurationImportSelector.class})"></a>@Import({AutoConfigurationImportSelector.class})</h5>
      <p><code>AutoConfigurationImportSelector</code>类是SpringBoot实现自动装配的关键。<code>AutoConfigurationImportSelector</code>实现了<code>DeferredImportSelector</code>（DeferredImportSelector接口， 表示为延迟导入）、<code>BeanClassLoaderAware</code>接口，而<code>DeferredImportSelector</code>又继承了<code>ImportSelector</code>接口。其中<b>selectImports</b>方法会返回一个数组，数组中的类后面都会注册到Spring容器中。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoConfigurationImportSelector</span></span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">DeferredImportSelector</span>, <span class="title">BeanClassLoaderAware</span>, <span class="title">ResourceLoaderAware</span>,</span></span><br><span class="line"><span class="class">        <span class="title">BeanFactoryAware</span>, <span class="title">EnvironmentAware</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">        ...				</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>DeferredImportSelector接口是ImportSelector接口的子接口，该接口会在所有的<code>@Configuration</code>配置类（<b>不包括自动化配置类，即spring.factories文件中的配置类</b>）处理完成后运行。<b>DeferredImportSelector</b>有两个特点：</p>
<ul>
<li>继承该接口的ImportSelector会在所有<b>@Configuration配置类处理完后运行</b>。这一点是因为在<code>ConfigurationClassParser#parse(java.util.Set&lt;org.springframework.beans.factory.config.BeanDefinitionHolder&gt;)</code> 方法中直到解析出来其他的候选配置类才会调用<code>this.deferredImportSelectorHandler.process();</code> 来解析<code>DeferredImportSelector</code></li>
<li>如果定义了一个以上的<code>DeferredImportSelector</code>则使用Order接口来进行排序。这一点也是在<code>this.deferredImportSelectorHandler.process();</code>中进行了排序调用。</li>
</ul>
<p><code>ImportSelector</code>接口类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> DeferredImportSelector</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> Import</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ImportBeanDefinitionRegistrar</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> Configuration</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ImportSelector</span> </span>&#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Select and return the names of which class(es) should be imported based on</span></span><br><span class="line"><span class="comment">	 * the &#123;<span class="doctag">@link</span> AnnotationMetadata&#125; of the importing @&#123;<span class="doctag">@link</span> Configuration&#125; class.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	String[] selectImports(AnnotationMetadata importingClassMetadata);</span><br></pre></td></tr></table></div></figure>
<p>该接口注释说明：实现该接口的selectImport则返回的String[]的 class字符串 类将被注册为@Configuration，即只要实现该接口返回的类将被注入Spring容器。@see ImportBeanDefinitionRegistrar则说明是使用 ImportBeanDefinitionRegistrar的registerBeanDefinitions方法进行注入。</p>
<p><code>AutoConfigurationImportSelector.AutoConfigurationGroup</code>类对<code>selectImports</code>方法实现</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//AutoConfigurationImportSelector.AutoConfigurationGroup</span></span><br><span class="line">   <span class="keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.isEnabled(annotationMetadata)) &#123;</span><br><span class="line">            <span class="keyword">return</span> NO_IMPORTS;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            AutoConfigurationImportSelector.AutoConfigurationEntry autoConfigurationEntry = <span class="keyword">this</span>.getAutoConfigurationEntry(annotationMetadata);</span><br><span class="line">            <span class="comment">// 返回的就是需要注册到IoC容器中的对象对应的类型的全类路径名称的字符串数组</span></span><br><span class="line">            <span class="comment">// [&quot;com.bobo.pojo.User&quot;,&quot;com.bobo.pojo.Person&quot;, ....]</span></span><br><span class="line">            <span class="keyword">return</span> StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>
<p>该方法的作用就是要返回需要注册到IoC容器中的对象对应的类型的全类路径名称的字符串数组。</p>
<p>下面我们重点对<code>getAutoConfigurationEntry(annotationMetadata)</code>进行分析。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> AutoConfigurationImportSelector.<span class="function">AutoConfigurationEntry <span class="title">getAutoConfigurationEntry</span><span class="params">(AnnotationMetadata annotationMetadata)</span> </span>&#123;</span><br><span class="line">      	<span class="comment">// 1. 判断是否开启注解。如未开启，返回空串</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.isEnabled(annotationMetadata)) &#123;</span><br><span class="line">            <span class="keyword">return</span> EMPTY_ENTRY;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//1、 获取注解的属性信息</span></span><br><span class="line">            AnnotationAttributes attributes = <span class="keyword">this</span>.getAttributes(annotationMetadata);</span><br><span class="line">            <span class="comment">//2、获取候选配置信息，加载的是当前项目的classpath目录下所有的spring.factories文件中的key为org.springframework.boot.autoconfigure.EnableAutoConfiguration的信息</span></span><br><span class="line">            List&lt;String&gt; configurations = <span class="keyword">this</span>.getCandidateConfigurations(annotationMetadata, attributes);</span><br><span class="line">            <span class="comment">//3、去除重复的配置类，若我们自己写的starter 可能存在重复的</span></span><br><span class="line">            configurations = <span class="keyword">this</span>.removeDuplicates(configurations);</span><br><span class="line">            <span class="comment">//4、如果项目中某些自动配置类，我们不希望其自动配置，我们可以通过EnableAutoConfiguration的exclude或excludeName属性进行配置，</span></span><br><span class="line">			<span class="comment">// 或者也可以在配置文件里通过配置项“spring.autoconfigure.exclude”进行配置。</span></span><br><span class="line">			<span class="comment">//找到不希望自动配置的配置类（根据EnableAutoConfiguration注解的一个exclusions属性）</span></span><br><span class="line">            Set&lt;String&gt; exclusions = <span class="keyword">this</span>.getExclusions(annotationMetadata, attributes);</span><br><span class="line">            <span class="comment">//4.1、校验排除类（exclusions指定的类必须是自动配置类，否则抛出异常）</span></span><br><span class="line">            <span class="keyword">this</span>.checkExcludedClasses(configurations, exclusions);</span><br><span class="line">           	<span class="comment">//4.2、将需要排除的类从 configurations remove掉</span></span><br><span class="line">            configurations.removeAll(exclusions);</span><br><span class="line">            <span class="comment">//5、 对所有候选的自动配置类进行筛选，根据项目pom.xml文件中加入的依赖文件筛选出最终符合当前项目运行环境对应的自动配置类</span></span><br><span class="line">            <span class="comment">//要判断@Conditional是否满足</span></span><br><span class="line">			<span class="comment">//如@ConditionalOnClass(&#123;SqlSessionFactory.class,SqlSessionFactoryBean.class&#125;)表示需要在类路径中存在SqlSessionFactory.class、SqlSessionFactoryBean.class这两个类才能完成自动注册。</span></span><br><span class="line">            configurations = <span class="keyword">this</span>.getConfigurationClassFilter().filter(configurations);</span><br><span class="line">            <span class="comment">//6、将自动配置导入事件通知监听器</span></span><br><span class="line">			<span class="comment">//当AutoConfigurationImportSelector过滤完成后会自动加载类路径下Jar包中META-INF/spring.factories文件中AutoConfigurationImportListener的实现类，</span></span><br><span class="line">			<span class="comment">//并触发fireAutoConfigurationImportEvents事件。</span></span><br><span class="line">            <span class="keyword">this</span>.fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AutoConfigurationImportSelector.AutoConfigurationEntry(configurations, exclusions);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>
<p>我们来看一下<code>getCandidateConfigurations(annotationMetadata, attributes)</code>方法是怎么拿到这些自动配置类的。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">getCandidateConfigurations</span><span class="params">(AnnotationMetadata metadata, AnnotationAttributes attributes)</span> </span>&#123;</span><br><span class="line">       List&lt;String&gt; configurations = SpringFactoriesLoader.loadFactoryNames(<span class="keyword">this</span>.getSpringFactoriesLoaderFactoryClass(), <span class="keyword">this</span>.getBeanClassLoader());</span><br><span class="line">       Assert.notEmpty(configurations, <span class="string">&quot;No auto configuration classes found in META-INF/spring.factories. If you are using a custom packaging, make sure that file is correct.&quot;</span>);</span><br><span class="line">       <span class="keyword">return</span> configurations;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>
<p>SpringFactoriesLoader.java类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">loadFactoryNames</span><span class="params">(Class&lt;?&gt; factoryClass, <span class="meta">@Nullable</span> ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">      String factoryClassName = factoryClass.getName();</span><br><span class="line">      <span class="keyword">return</span> (List)loadSpringFactories(classLoader).getOrDefault(factoryClassName, Collections.emptyList());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; loadSpringFactories(<span class="meta">@Nullable</span> ClassLoader classLoader) &#123;</span><br><span class="line">      MultiValueMap&lt;String, String&gt; result = (MultiValueMap)cache.get(classLoader);</span><br><span class="line">      <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> result;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              Enumeration&lt;URL&gt; urls = classLoader != <span class="keyword">null</span> ? classLoader.getResources(<span class="string">&quot;META-INF/spring.factories&quot;</span>) : ClassLoader.getSystemResources(<span class="string">&quot;META-INF/spring.factories&quot;</span>);</span><br><span class="line">              LinkedMultiValueMap result = <span class="keyword">new</span> LinkedMultiValueMap();</span><br><span class="line"></span><br><span class="line">              <span class="keyword">while</span>(urls.hasMoreElements()) &#123;</span><br><span class="line">                  URL url = (URL)urls.nextElement();</span><br><span class="line">                  UrlResource resource = <span class="keyword">new</span> UrlResource(url);</span><br><span class="line">                  Properties properties = PropertiesLoaderUtils.loadProperties(resource);</span><br><span class="line">                  Iterator var6 = properties.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">                  <span class="keyword">while</span>(var6.hasNext()) &#123;</span><br><span class="line">                      Entry&lt;?, ?&gt; entry = (Entry)var6.next();</span><br><span class="line">                      String factoryClassName = ((String)entry.getKey()).trim();</span><br><span class="line">                      String[] var9 = StringUtils.commaDelimitedListToStringArray((String)entry.getValue());</span><br><span class="line">                      <span class="keyword">int</span> var10 = var9.length;</span><br><span class="line"></span><br><span class="line">                      <span class="keyword">for</span>(<span class="keyword">int</span> var11 = <span class="number">0</span>; var11 &lt; var10; ++var11) &#123;</span><br><span class="line">                          String factoryName = var9[var11];</span><br><span class="line">                          result.add(factoryClassName, factoryName.trim());</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              cache.put(classLoader, result);</span><br><span class="line">              <span class="keyword">return</span> result;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException var13) &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unable to load factories from location [META-INF/spring.factories]&quot;</span>, var13);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;  </span><br></pre></td></tr></table></div></figure>
<p>通过<code>SpringFactoriesLoader</code>扫描所有的<code>META-INF/spring.factories</code>中所有路径下的类全路径名（key为<code>org.springframework.boot.autoconfigure.EnableAutoConfiguration</code>），并通过反射实例化成一个个的配置类并注入到Spring容器中，从而实现了自动装配。<br>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="EnableAutoConfiguration.png">
      </p>
<p>接着我们看下<code>this.getExclusions(annotationMetadata, attributes);</code>方法的作用。该方法用于排除主类上<code>@SpringBootApplication</code>注解上排除的自动装配的类。比如我们在该注解上排除我们自定义starter的自动装配的类，<code>@SpringBootApplication(exclude = &#123;com.demo.starter.config.DemoConfig.class&#125;)</code>（当然也可以用excludeName进行排除），那么在后面的<code>configurations.removeAll(exclusions);</code>方法中将会删除我们的<code>com.demo.starter.config.DemoConfig.class</code>。</p>
<p><code>configurations=filter(configurations,autoConfigurationMetadata);</code>该行代码将会过滤掉不需要装配的类。过滤的逻辑有很多，比如我们常用的@ConditionXXX注解。如下所示：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConditionalOnBean</span>:容器中有指定的Bean</span><br><span class="line"><span class="meta">@ConditionalOnClass</span>：当类路径下有指定的类</span><br><span class="line"><span class="meta">@ConditionalOnExpression</span>:基于SpEL表达式作为判断条件</span><br><span class="line"><span class="meta">@ConditionalOnJava</span>:基于JVM版本作为判断条件</span><br><span class="line"><span class="meta">@ConditionalOnJndi</span>:在JNDI存在的条件下查找指定的位置</span><br><span class="line"><span class="meta">@ConditionalOnMissingBean</span>:当容器中没有指定Bean的情况下</span><br><span class="line"><span class="meta">@ConditionalOnMissingClass</span>:当类路径下没有指定的类</span><br><span class="line"><span class="meta">@ConditionalOnNotWebApplication</span>:当前项目不是Web项目</span><br><span class="line"><span class="meta">@ConditionalOnProperty</span>:配置文件中指定的属性是否有指定的值</span><br><span class="line"><span class="meta">@ConditionalOnResource</span>:类路径下是否有指定的资源</span><br><span class="line"><span class="meta">@ConditionalOnSingleCandidate</span>:当指定Bean在容器中只有一个，或者虽然有多个但是指定首选Bean</span><br><span class="line"><span class="meta">@ConditionalOnWebApplication</span>:当前项目是Web项目的条件下</span><br></pre></td></tr></table></div></figure>

        <h4 id="ComponentScan">
          <a href="#ComponentScan" class="heading-link"><i class="fas fa-link"></i></a><a href="#ComponentScan" class="headerlink" title="@ComponentScan"></a>@ComponentScan</h4>
      <p>默认扫描启动类所在包以及子包路径下全部类</p>

        <h4 id="小结">
          <a href="#小结" class="heading-link"><i class="fas fa-link"></i></a><a href="#小结" class="headerlink" title="小结"></a>小结</h4>
      <p>实现自动装配这块最核心的注解就是<code>@EnableAutoConfiguration</code>，其中起作用的子注解为<code>@Import(&#123;AutoConfigurationImportSelector.class&#125;)</code>。在<code>AutoConfigurationImportSelector.AutoConfigurationGroup</code>的<code>selectImports</code>方法中，通过<code>SpringFactoriesLoader</code>的<code>loadFactoryNames()</code>方法扫描到所有<code>META-INF/spring.factories</code>文件中对应key为<code>org.springframework.boot.autoconfigure.EnableAutoConfiguration</code>的类全路径名。并通过<code>getExclusions</code>、<code>.getConfigurationClassFilter().filter(configurations)</code>进行过滤处理。</p>
<p>决定一个XxxAutoConfiguration是否需要进行装配，由以下几方面控制:</p>
<blockquote>
<ul>
<li>@EnableAutoConfiguration参数控制</li>
<li>spring.autoconfigure.exclude参数控制</li>
<li>spring-autoconfigure-metadata.properties文件中指定的规则控制</li>
<li>XxxAutoConfiguration本身的条件控制，如硬编码的@ConditionalOn</li>
</ul>
</blockquote>
<p>那么<code>selectImports</code>返回的类全路径名称数组在何时加载、实例化加入到IOC容器呢？在下面的章节最后部分会讲到。</p>

        <h3 id="Spring-Boot启动过程（从代码run-入手）">
          <a href="#Spring-Boot启动过程（从代码run-入手）" class="heading-link"><i class="fas fa-link"></i></a><a href="#Spring-Boot启动过程（从代码run-入手）" class="headerlink" title="Spring Boot启动过程（从代码run()入手）"></a>Spring Boot启动过程（从代码run()入手）</h3>
      <p>SpringBoot项目的mian函数代码</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>
<p>我们进入<code>run()</code>方法看下，其代码在SpringApplication.class文件。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(Class&lt;?&gt; primarySource, String... args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> run(<span class="keyword">new</span> Class[]&#123;primarySource&#125;, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(Class&lt;?&gt;[] primarySources, String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> SpringApplication(primarySources)).run(args);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>
<p>我们发现其实其首先是创建了SpringApplication的实例，然后调用了SpringApplication的run()方法。</p>

        <h4 id="创建SpringApplication实例">
          <a href="#创建SpringApplication实例" class="heading-link"><i class="fas fa-link"></i></a><a href="#创建SpringApplication实例" class="headerlink" title="创建SpringApplication实例"></a>创建SpringApplication实例</h4>
      <p>接下来我们看下SpringApplication构造函数：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SpringApplication</span><span class="params">(Class&lt;?&gt;... primarySources)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>((ResourceLoader)<span class="keyword">null</span>, primarySources);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.sources = <span class="keyword">new</span> LinkedHashSet();</span><br><span class="line">       <span class="keyword">this</span>.bannerMode = Mode.CONSOLE;</span><br><span class="line">       <span class="keyword">this</span>.logStartupInfo = <span class="keyword">true</span>;</span><br><span class="line">       <span class="keyword">this</span>.addCommandLineProperties = <span class="keyword">true</span>;</span><br><span class="line">       <span class="keyword">this</span>.addConversionService = <span class="keyword">true</span>;</span><br><span class="line">       <span class="keyword">this</span>.headless = <span class="keyword">true</span>;</span><br><span class="line">       <span class="keyword">this</span>.registerShutdownHook = <span class="keyword">true</span>;</span><br><span class="line">       <span class="keyword">this</span>.additionalProfiles = <span class="keyword">new</span> HashSet();</span><br><span class="line">       <span class="keyword">this</span>.isCustomEnvironment = <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">       Assert.notNull(primarySources, <span class="string">&quot;PrimarySources must not be null&quot;</span>);</span><br><span class="line">       <span class="comment">//项目启动类 Application.class设置为属性存储起来</span></span><br><span class="line">       <span class="keyword">this</span>.primarySources = <span class="keyword">new</span> LinkedHashSet(Arrays.asList(primarySources));</span><br><span class="line">       <span class="comment">//设置应用类型是SERVLET应用（Spring 5之前的传统MVC应用）还是REACTIVE应用（Spring 5开始出现的WebFlux交互式应用）</span></span><br><span class="line">       <span class="keyword">this</span>.webApplicationType = WebApplicationType.deduceFromClasspath();</span><br><span class="line">       <span class="comment">//设置初始化器(Initializer),最后会调用这些初始化器</span></span><br><span class="line">	<span class="comment">//所谓的初始化器就是org.springframework.context.ApplicationContextInitializer的实现类,在Spring上下文被刷新之前进行初始化的操作</span></span><br><span class="line">       <span class="keyword">this</span>.setInitializers(<span class="keyword">this</span>.getSpringFactoriesInstances(ApplicationContextInitializer.class));</span><br><span class="line">       <span class="comment">// 设置监听器(Listener)</span></span><br><span class="line">       <span class="keyword">this</span>.setListeners(<span class="keyword">this</span>.getSpringFactoriesInstances(ApplicationListener.class));</span><br><span class="line">       <span class="comment">//初始化 mainApplicationClass 属性:用于推断并设置项目main()方法启动的主程序启动类</span></span><br><span class="line">       <span class="keyword">this</span>.mainApplicationClass = <span class="keyword">this</span>.deduceMainApplicationClass();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>
<p>在实例化SpringApplication中设置的初始化器和监听器都是在/META-INF/spring.factories 中获取的。<br>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="%E5%90%AF%E5%8A%A8%E7%B1%BBListener%E5%92%8CInitializer.png">
      </p>

        <h5 id="deduceFromClasspath-推断应用的类型">
          <a href="#deduceFromClasspath-推断应用的类型" class="heading-link"><i class="fas fa-link"></i></a><a href="#deduceFromClasspath-推断应用的类型" class="headerlink" title="deduceFromClasspath()-推断应用的类型"></a>deduceFromClasspath()-推断应用的类型</h5>
      <p>我们看下WebApplicationType枚举类</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">WebApplicationType</span> </span>&#123;</span><br><span class="line">    NONE,</span><br><span class="line">    SERVLET,</span><br><span class="line">    REACTIVE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] SERVLET_INDICATOR_CLASSES = <span class="keyword">new</span> String[]&#123;<span class="string">&quot;javax.servlet.Servlet&quot;</span>, <span class="string">&quot;org.springframework.web.context.ConfigurableWebApplicationContext&quot;</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEBMVC_INDICATOR_CLASS = <span class="string">&quot;org.springframework.web.servlet.DispatcherServlet&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEBFLUX_INDICATOR_CLASS = <span class="string">&quot;org.springframework.web.reactive.DispatcherHandler&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String JERSEY_INDICATOR_CLASS = <span class="string">&quot;org.glassfish.jersey.servlet.ServletContainer&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVLET_APPLICATION_CONTEXT_CLASS = <span class="string">&quot;org.springframework.web.context.WebApplicationContext&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String REACTIVE_APPLICATION_CONTEXT_CLASS = <span class="string">&quot;org.springframework.boot.web.reactive.context.ReactiveWebApplicationContext&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">WebApplicationType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> WebApplicationType <span class="title">deduceFromClasspath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ClassUtils.isPresent(<span class="string">&quot;org.springframework.web.reactive.DispatcherHandler&quot;</span>, (ClassLoader)<span class="keyword">null</span>) &amp;&amp; !ClassUtils.isPresent(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet&quot;</span>, (ClassLoader)<span class="keyword">null</span>) &amp;&amp; !ClassUtils.isPresent(<span class="string">&quot;org.glassfish.jersey.servlet.ServletContainer&quot;</span>, (ClassLoader)<span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> REACTIVE;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String[] var0 = SERVLET_INDICATOR_CLASSES;</span><br><span class="line">            <span class="keyword">int</span> var1 = var0.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var2 = <span class="number">0</span>; var2 &lt; var1; ++var2) &#123;</span><br><span class="line">                String className = var0[var2];</span><br><span class="line">                <span class="keyword">if</span> (!ClassUtils.isPresent(className, (ClassLoader)<span class="keyword">null</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NONE;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> SERVLET;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ul>
<li>NONE: 应用程序不是web应用，也不应该用web服务器去启动</li>
<li>SERVLET: 应用程序应作为基于servlet的web应用程序运行，并应启动嵌入式servlet web（tomcat）服务器。</li>
<li>REACTIVE: 应用程序应作为 reactive web应用程序运行，并应启动嵌入式 reactive web服务器。</li>
</ul>

        <h4 id="run方法逻辑">
          <a href="#run方法逻辑" class="heading-link"><i class="fas fa-link"></i></a><a href="#run方法逻辑" class="headerlink" title="run方法逻辑"></a>run方法逻辑</h4>
      <p>run方法在SpringApplication.class中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">	    <span class="comment">// 创建 StopWatch 对象，并启动。StopWatch 主要用于简单统计 run 启动过程的时长。</span></span><br><span class="line">        StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">        stopWatch.start();</span><br><span class="line">        <span class="comment">// ConfigurableApplicationContext Spring 的上下文</span></span><br><span class="line">        ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">        Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        <span class="keyword">this</span>.configureHeadlessProperty();</span><br><span class="line">        <span class="comment">//1、从META-INF/spring.factories中获取并启动监听器</span></span><br><span class="line">        SpringApplicationRunListeners listeners = <span class="keyword">this</span>.getRunListeners(args);</span><br><span class="line">        listeners.starting();</span><br><span class="line"></span><br><span class="line">        Collection exceptionReporters;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        	<span class="comment">//创建  ApplicationArguments 对象 初始化默认应用参数类</span></span><br><span class="line">			<span class="comment">// args是启动Spring应用的命令行参数，该参数可以在Spring应用中被访问。如：--server.port=9000</span></span><br><span class="line">            ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(args);</span><br><span class="line">            <span class="comment">//2、项目运行环境Environment的预配置</span></span><br><span class="line">			<span class="comment">// 创建并配置当前SpringBoot应用将要使用的Environment</span></span><br><span class="line">			<span class="comment">// 并遍历调用所有的SpringApplicationRunListener的environmentPrepared()方法</span></span><br><span class="line">            ConfigurableEnvironment environment = <span class="keyword">this</span>.prepareEnvironment(listeners, applicationArguments);</span><br><span class="line">            <span class="keyword">this</span>.configureIgnoreBeanInfo(environment);</span><br><span class="line">            <span class="comment">// 准备Banner打印器 - 就是启动Spring Boot的时候打印在console上的ASCII艺术字体</span></span><br><span class="line">            Banner printedBanner = <span class="keyword">this</span>.printBanner(environment);</span><br><span class="line">            <span class="comment">//3、创建Spring容器,初始化应用上下文</span></span><br><span class="line">            context = <span class="keyword">this</span>.createApplicationContext();</span><br><span class="line">            <span class="comment">//实例化SpringBootExceptionReporter.class，用来支持报告关于启动的错误，也是利用getSpringFactoriesInstances方法来获取配置的异常类名称并实例化所有的异常处理类</span></span><br><span class="line">            exceptionReporters = <span class="keyword">this</span>.getSpringFactoriesInstances(SpringBootExceptionReporter.class, <span class="keyword">new</span> Class[]&#123;ConfigurableApplicationContext.class&#125;, context);</span><br><span class="line">            <span class="comment">//4、Spring容器前置处理</span></span><br><span class="line">			<span class="comment">//这一步主要是在容器刷新之前的准备动作。包含一个非常关键的操作：将启动类注入容器，为后续开启自动化配置奠定基础。</span></span><br><span class="line">            <span class="keyword">this</span>.prepareContext(context, environment, listeners, applicationArguments, printedBanner);</span><br><span class="line">            <span class="comment">//5、刷新容器</span></span><br><span class="line">            <span class="keyword">this</span>.refreshContext(context);</span><br><span class="line">            <span class="comment">//6、Spring容器后置处理</span></span><br><span class="line">			<span class="comment">//扩展接口，设计模式中的模板方法，默认为空实现。</span></span><br><span class="line">			<span class="comment">// 如果有自定义需求，可以重写该方法。比如打印一些启动结束log，或者一些其它后置处理</span></span><br><span class="line">            <span class="keyword">this</span>.afterRefresh(context, applicationArguments);</span><br><span class="line">            <span class="comment">//停止 StopWatch 统计时长</span></span><br><span class="line">            stopWatch.stop();</span><br><span class="line">            <span class="comment">//打印 Spring Boot 启动的时长日志。</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">                (<span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass)).logStarted(<span class="keyword">this</span>.getApplicationLog(), stopWatch);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//7、发出结束执行的事件通知</span></span><br><span class="line">            listeners.started(context);</span><br><span class="line">            <span class="comment">//8、执行Runners</span></span><br><span class="line">			<span class="comment">//用于调用项目中自定义的执行器XxxRunner类，使得在项目启动完成后立即执行一些特定程序</span></span><br><span class="line">			<span class="comment">//Runner 运行器用于在服务启动时进行一些业务初始化操作，这些操作只在服务启动后执行一次。</span></span><br><span class="line">			<span class="comment">//Spring Boot提供了ApplicationRunner和CommandLineRunner两种服务接口</span></span><br><span class="line">            <span class="keyword">this</span>.callRunners(context, applicationArguments);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var10) &#123;</span><br><span class="line">            <span class="keyword">this</span>.handleRunFailure(context, var10, exceptionReporters, listeners);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(var10);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        	<span class="comment">//9、发布应用上下文就绪事件</span></span><br><span class="line">			<span class="comment">//表示在前面一切初始化启动都没有问题的情况下，使用运行监听器SpringApplicationRunListener持续运行配置好的应用上下文ApplicationContext，</span></span><br><span class="line">			<span class="comment">// 这样整个Spring Boot项目就正式启动完成了。</span></span><br><span class="line">            listeners.running(context);</span><br><span class="line">            <span class="keyword">return</span> context;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var9) &#123;</span><br><span class="line">            <span class="keyword">this</span>.handleRunFailure(context, var9, exceptionReporters, (SpringApplicationRunListeners)<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(var9);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>
<p>run方法步骤一共分为9步：</p>
<ul>
<li>获取并启动监听器，监听器也是在spring.factories中获取的。</li>
<li>项目运行环境Environment的预配置</li>
<li>创建Spring容器</li>
<li>Spring容器前置处理，这一步主要是在容器刷新之前的准备动作。包含一个非常关键的操作：将启动类注入容器，为后续开启自动化配置奠定基础。</li>
<li>刷新容器</li>
<li>Spring容器后置处理，扩展接口，设计模式中的模板方法，默认为空实现。</li>
<li>向监听器发出结束执行的事件通知</li>
<li>执行Runners</li>
<li>向监听器发布应用上下文就绪事件<br>上述步骤中，最重要的为第4、5步。</li>
</ul>

        <h5 id="第一步：获取并启动监听器">
          <a href="#第一步：获取并启动监听器" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一步：获取并启动监听器" class="headerlink" title="第一步：获取并启动监听器"></a>第一步：获取并启动监听器</h5>
      <p>事件机制在Spring是很重要的一部分内容，通过事件机制我们可以监听Spring容器中正在发生的一些事件，同样也可以自定义监听事件。Spring的事件为Bean和Bean之间的消息传递提供支持。当一个对象处理完某种任务后，通知另外的对象进行某些处理，常用的场景有进行某些操作后发送通知，消息、邮件等情况。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> SpringApplicationRunListeners <span class="title">getRunListeners</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       Class&lt;?&gt;[] types = <span class="keyword">new</span> Class[]&#123;SpringApplication.class, String[].class&#125;;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> SpringApplicationRunListeners(logger, <span class="keyword">this</span>.getSpringFactoriesInstances(SpringApplicationRunListener.class, types, <span class="keyword">this</span>, args));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>
<p>这里也是从<code>META-INF/spring.factories</code>获取指定的监听器实例<br>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="SpringApplicationRunListener.png">
      <br>可以看到<code>EventPublishingRunListener</code>监听器是Spring容器的启动监听器。</p>

        <h5 id="第二步：配置项目运行环境">
          <a href="#第二步：配置项目运行环境" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二步：配置项目运行环境" class="headerlink" title="第二步：配置项目运行环境"></a>第二步：配置项目运行环境</h5>
      <p>这里的运行环境包括计算机的环境，Java环境，Spring的运行环境，Spring项目的配置（在SpringBoot中就是那个熟悉的application.properties/yml）等等。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ConfigurableEnvironment <span class="title">prepareEnvironment</span><span class="params">(SpringApplicationRunListeners listeners, ApplicationArguments applicationArguments)</span> </span>&#123;</span><br><span class="line">     <span class="comment">//创建并配置相应的环境</span></span><br><span class="line">     ConfigurableEnvironment environment = <span class="keyword">this</span>.getOrCreateEnvironment();</span><br><span class="line">     <span class="comment">//根据用户配置，配置 environment系统环境</span></span><br><span class="line">     <span class="keyword">this</span>.configureEnvironment((ConfigurableEnvironment)environment, applicationArguments.getSourceArgs());</span><br><span class="line">     <span class="comment">//启动相应的监听器，其中一个重要的监听器 ConfigFileApplicationListener 就是加载项目配置文件的监听器。</span></span><br><span class="line">     listeners.environmentPrepared((ConfigurableEnvironment)environment);</span><br><span class="line">     <span class="keyword">this</span>.bindToSpringApplication((ConfigurableEnvironment)environment);</span><br><span class="line">     <span class="keyword">if</span> (!<span class="keyword">this</span>.isCustomEnvironment) &#123;</span><br><span class="line">         environment = (<span class="keyword">new</span> EnvironmentConverter(<span class="keyword">this</span>.getClassLoader())).convertEnvironmentIfNecessary((ConfigurableEnvironment)environment, <span class="keyword">this</span>.deduceEnvironmentClass());</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     ConfigurationPropertySources.attach((Environment)environment);</span><br><span class="line">     <span class="keyword">return</span> (ConfigurableEnvironment)environment;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></div></figure>
<p>该方法中主要完成的工作，首先是创建并按照相应的应用类型配置相应的环境，然后根据用户的配置，配置系统环境，然后启动监听器，并加载系统配置文件。</p>

        <h6 id="configureEnvironment-ConfigurableEnvironment-environment-String-args">
          <a href="#configureEnvironment-ConfigurableEnvironment-environment-String-args" class="heading-link"><i class="fas fa-link"></i></a><a href="#configureEnvironment-ConfigurableEnvironment-environment-String-args" class="headerlink" title="configureEnvironment(ConfigurableEnvironment environment, String[] args)"></a>configureEnvironment(ConfigurableEnvironment environment, String[] args)</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configureEnvironment</span><span class="params">(ConfigurableEnvironment environment, String[] args)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.addConversionService) &#123;</span><br><span class="line">           ConversionService conversionService = ApplicationConversionService.getSharedInstance();</span><br><span class="line">           environment.setConversionService((ConfigurableConversionService)conversionService);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//将main 函数的args封装成 SimpleCommandLinePropertySource 加入环境中。	</span></span><br><span class="line">       <span class="keyword">this</span>.configurePropertySources(environment, args);</span><br><span class="line">       <span class="comment">// 激活相应的配置文件</span></span><br><span class="line">       <span class="keyword">this</span>.configureProfiles(environment, args);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configurePropertySources</span><span class="params">(ConfigurableEnvironment environment, String[] args)</span> </span>&#123;</span><br><span class="line">       MutablePropertySources sources = environment.getPropertySources();</span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.defaultProperties != <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.defaultProperties.isEmpty()) &#123;</span><br><span class="line">           sources.addLast(<span class="keyword">new</span> MapPropertySource(<span class="string">&quot;defaultProperties&quot;</span>, <span class="keyword">this</span>.defaultProperties));</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (<span class="keyword">this</span>.addCommandLineProperties &amp;&amp; args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">           String name = <span class="string">&quot;commandLineArgs&quot;</span>;</span><br><span class="line">           <span class="keyword">if</span> (sources.contains(name)) &#123;</span><br><span class="line">               PropertySource&lt;?&gt; source = sources.get(name);</span><br><span class="line">               CompositePropertySource composite = <span class="keyword">new</span> CompositePropertySource(name);</span><br><span class="line">               composite.addPropertySource(<span class="keyword">new</span> SimpleCommandLinePropertySource(<span class="string">&quot;springApplicationCommandLineArgs&quot;</span>, args));</span><br><span class="line">               composite.addPropertySource(source);</span><br><span class="line">               sources.replace(name, composite);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               sources.addFirst(<span class="keyword">new</span> SimpleCommandLinePropertySource(args));</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configureProfiles</span><span class="params">(ConfigurableEnvironment environment, String[] args)</span> </span>&#123;</span><br><span class="line">       environment.getActiveProfiles();</span><br><span class="line">       Set&lt;String&gt; profiles = <span class="keyword">new</span> LinkedHashSet(<span class="keyword">this</span>.additionalProfiles);</span><br><span class="line">       profiles.addAll(Arrays.asList(environment.getActiveProfiles()));</span><br><span class="line">       environment.setActiveProfiles(StringUtils.toStringArray(profiles));</span><br><span class="line"> &#125;  </span><br><span class="line"></span><br></pre></td></tr></table></div></figure>
<p>如我们给项目提供了两个配置文件<code>application-dev.yml</code>和<code>application-prod.yml</code>。当我们想要在生产环境使用<code>application-prod.yml</code>配置时，只需要在启动参数增加<code>--spring.profiles.active=prod</code>。这其中就用到了<code>configurePropertySources(environment, args);</code>中将args封装成了<code>SimpleCommandLinePropertySource</code>并加入到了environment中，同时利用<code>configureProfiles(environment, args);</code>根据启动参数激活了相应的配置文件。</p>

        <h6 id="listeners-environmentPrepared-ConfigurableEnvironment-environment">
          <a href="#listeners-environmentPrepared-ConfigurableEnvironment-environment" class="heading-link"><i class="fas fa-link"></i></a><a href="#listeners-environmentPrepared-ConfigurableEnvironment-environment" class="headerlink" title="listeners.environmentPrepared((ConfigurableEnvironment)environment)"></a>listeners.environmentPrepared((ConfigurableEnvironment)environment)</h6>
      <p>在SpringApplication实例化对象过程中，<code>this.setListeners(this.getSpringFactoriesInstances(ApplicationListener.class));</code>会获取并加载<code>META-INF/spring.factories</code>中key为<code>org.springframework.context.ApplicationListener</code>下的所有Listener。<br>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="SpringApplicationListener.png">
      </p>
<p>在<code>environmentPrepared</code>方法中，<code>ConfigFileApplicationListener</code>会从以下几个位置加载配置文件内容</p>
<ul>
<li>classpath:</li>
<li>file:./</li>
<li>classpath:config/</li>
<li>file:./config/:</li>
</ul>

        <h5 id="第三步：创建Spring容器">
          <a href="#第三步：创建Spring容器" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三步：创建Spring容器" class="headerlink" title="第三步：创建Spring容器"></a>第三步：创建Spring容器</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ConfigurableApplicationContext <span class="title">createApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; contextClass = <span class="keyword">this</span>.applicationContextClass;</span><br><span class="line">    <span class="keyword">if</span> (contextClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span>(<span class="keyword">this</span>.webApplicationType) &#123;</span><br><span class="line">            <span class="keyword">case</span> SERVLET:</span><br><span class="line">                contextClass = Class.forName(<span class="string">&quot;org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> REACTIVE:</span><br><span class="line">                contextClass = Class.forName(<span class="string">&quot;org.springframework.boot.web.reactive.context.AnnotationConfigReactiveWebServerApplicationContext&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                contextClass = Class.forName(<span class="string">&quot;org.springframework.context.annotation.AnnotationConfigApplicationContext&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Unable create a default ApplicationContext, please specify an ApplicationContextClass&quot;</span>, var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (ConfigurableApplicationContext)BeanUtils.instantiateClass(contextClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>以web工程为例，即其上下文为<code>AnnotationConfigServletWebServerApplicationContext</code>，我们先看一下AnnotationConfigServletWebServerApplicationContext的设计。<br>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="AnnotationConfigServletWebServerApplicationContext.png">
      </p>

        <h5 id="第四步：Spring容器前置处理（关键）">
          <a href="#第四步：Spring容器前置处理（关键）" class="heading-link"><i class="fas fa-link"></i></a><a href="#第四步：Spring容器前置处理（关键）" class="headerlink" title="第四步：Spring容器前置处理（关键）"></a>第四步：Spring容器前置处理（关键）</h5>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareContext</span><span class="params">(ConfigurableApplicationContext context, ConfigurableEnvironment environment, SpringApplicationRunListeners listeners, ApplicationArguments applicationArguments, Banner printedBanner)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//设置容器环境</span></span><br><span class="line">        context.setEnvironment(environment);</span><br><span class="line">        <span class="comment">//执行容器后置处理</span></span><br><span class="line">        <span class="keyword">this</span>.postProcessApplicationContext(context);</span><br><span class="line">        <span class="comment">//执行容器中的 ApplicationContextInitializer 包括spring.factories和通过三种方式自定义的</span></span><br><span class="line">        <span class="keyword">this</span>.applyInitializers(context);</span><br><span class="line">		<span class="comment">//触发所有 SpringApplicationRunListener 监听器的 contextPrepared 事件方法</span></span><br><span class="line">        listeners.contextPrepared(context);</span><br><span class="line">        <span class="comment">//记录启动日志</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">            <span class="keyword">this</span>.logStartupInfo(context.getParent() == <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.logStartupProfileInfo(context);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将main函数中的args参数封装成单例Bean，注册进容器</span></span><br><span class="line">        ConfigurableListableBeanFactory beanFactory = context.getBeanFactory();</span><br><span class="line">        beanFactory.registerSingleton(<span class="string">&quot;springApplicationArguments&quot;</span>, applicationArguments);</span><br><span class="line">        <span class="comment">//将 printedBanner 也封装成单例，注册进容器</span></span><br><span class="line">        <span class="keyword">if</span> (printedBanner != <span class="keyword">null</span>) &#123;</span><br><span class="line">            beanFactory.registerSingleton(<span class="string">&quot;springBootBanner&quot;</span>, printedBanner);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (beanFactory <span class="keyword">instanceof</span> DefaultListableBeanFactory) &#123;</span><br><span class="line">            ((DefaultListableBeanFactory)beanFactory).setAllowBeanDefinitionOverriding(<span class="keyword">this</span>.allowBeanDefinitionOverriding);</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="comment">// Load the sources，在getAllSources()中拿到了我们的启动类</span></span><br><span class="line">        Set&lt;Object&gt; sources = <span class="keyword">this</span>.getAllSources();</span><br><span class="line">        Assert.notEmpty(sources, <span class="string">&quot;Sources must not be empty&quot;</span>);</span><br><span class="line">		<span class="comment">//加载我们的启动类，将启动类注入容器,为后续开启自动化配置奠定基础</span></span><br><span class="line">        <span class="keyword">this</span>.load(context, sources.toArray(<span class="keyword">new</span> Object[<span class="number">0</span>]));</span><br><span class="line">		<span class="comment">//触发所有 SpringApplicationRunListener 监听器的 contextLoaded 事件方法</span></span><br><span class="line">        listeners.contextLoaded(context);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>
<p>在前置处理中最核心的一步是加载我们的启动类，将启动类注入容器。</p>

        <h5 id="第五步：刷新容器（关键）">
          <a href="#第五步：刷新容器（关键）" class="heading-link"><i class="fas fa-link"></i></a><a href="#第五步：刷新容器（关键）" class="headerlink" title="第五步：刷新容器（关键）"></a>第五步：刷新容器（关键）</h5>
      <p>refresh相关代码：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshContext</span><span class="params">(ConfigurableApplicationContext context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.refresh(context);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.registerShutdownHook) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                context.registerShutdownHook();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (AccessControlException var3) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">(ApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        Assert.isInstanceOf(AbstractApplicationContext.class, applicationContext);</span><br><span class="line">        ((AbstractApplicationContext)applicationContext).refresh();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">        	<span class="comment">// 第一步 刷新前的预处理</span></span><br><span class="line">            <span class="keyword">this</span>.prepareRefresh();</span><br><span class="line">            <span class="comment">// 第二步 1.创建BeanFactory实例，默认实现是DefaultListableBeanFactory</span></span><br><span class="line">			<span class="comment">//       2.解析XML中的&lt;bean&gt;为BeanDefition 并注册到 BeanDefitionRegistry</span></span><br><span class="line">            ConfigurableListableBeanFactory beanFactory = <span class="keyword">this</span>.obtainFreshBeanFactory();</span><br><span class="line">            <span class="comment">// 第三步 BeanFactory的预准备⼯作（BeanFactory进⾏⼀些设置，⽐如context的类加载器等）</span></span><br><span class="line">            <span class="keyword">this</span>.prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 第四步 BeanFactory准备工作完成后的后置处理工作,钩子方法，等子类重写</span></span><br><span class="line">                <span class="keyword">this</span>.postProcessBeanFactory(beanFactory);</span><br><span class="line">                <span class="comment">// 第五步 实例化并调⽤实现了BeanFactoryPostProcessor接⼝的Bean</span></span><br><span class="line">				<span class="comment">// 提前初始化工厂后置处理器bean，并调用postProcessBeanFactory方法</span></span><br><span class="line">				<span class="comment">//其中BeanFactoryPostProcessor比较重要的一个ConfigurationClassPostProcessor在这里调用，</span></span><br><span class="line">				<span class="comment">//用来遍历BeanDefinitionRegistry中现有的BeanDefinition解析@Import、@Configuration</span></span><br><span class="line">				<span class="comment">// 、@ComponentScan等注解将注解覆盖到的类也注册到BeanDefinitionRegistry中</span></span><br><span class="line">                <span class="keyword">this</span>.invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line">                <span class="comment">// 第六步 注册BeanPostProcessor（Bean的后置处理器），在创建bean的前后等执行</span></span><br><span class="line">                <span class="keyword">this</span>.registerBeanPostProcessors(beanFactory);</span><br><span class="line">                <span class="comment">// 第七步 初始化MessageSource组件（做国际化功能；消息绑定，消息解析）；</span></span><br><span class="line">                <span class="keyword">this</span>.initMessageSource();</span><br><span class="line">                <span class="comment">// 第八步 初始化事件派发器</span></span><br><span class="line">                <span class="keyword">this</span>.initApplicationEventMulticaster();</span><br><span class="line">                <span class="comment">// 第九步 ⼦类重写这个⽅法，在容器刷新的时候可以⾃定义逻辑，钩子方法</span></span><br><span class="line">                <span class="keyword">this</span>.onRefresh();</span><br><span class="line">                <span class="comment">// 第十步 注册应⽤的监听器。就是注册实现了ApplicationListener接⼝的监听器bean</span></span><br><span class="line">                <span class="keyword">this</span>.registerListeners();</span><br><span class="line">                <span class="comment">// 第十一步 初始化所有剩下的⾮懒加载的单例bean</span></span><br><span class="line">				<span class="comment">//1）.初始化创建⾮懒加载⽅式的单例Bean实例（未设置属性）</span></span><br><span class="line">				<span class="comment">//2）.填充属性</span></span><br><span class="line">				<span class="comment">//3) .如果bean实现了Aware相关接口,则调用Aware接口的实现方法</span></span><br><span class="line">				<span class="comment">//4) .调用BeanPostProcessor处理器的前置方法</span></span><br><span class="line">				<span class="comment">//5）.初始化⽅法调⽤（⽐如调⽤afterPropertiesSet⽅法、init-method⽅法）</span></span><br><span class="line">				<span class="comment">//6）.调⽤BeanPostProcessor（后置处理器）对实例bean进⾏后置处</span></span><br><span class="line">                <span class="keyword">this</span>.finishBeanFactoryInitialization(beanFactory);</span><br><span class="line">                <span class="comment">// 第十二步 完成context的刷新。主要是调⽤LifecycleProcessor的onRefresh()⽅法，并且发布事件 （ContextRefreshedEvent）</span></span><br><span class="line">                <span class="keyword">this</span>.finishRefresh();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (BeansException var9) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isWarnEnabled()) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.logger.warn(<span class="string">&quot;Exception encountered during context initialization - cancelling refresh attempt: &quot;</span> + var9);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>.destroyBeans();</span><br><span class="line">                <span class="keyword">this</span>.cancelRefresh(var9);</span><br><span class="line">                <span class="keyword">throw</span> var9;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.resetCommonCaches();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>

        <h5 id="invokeBeanFactoryPostProcessors">
          <a href="#invokeBeanFactoryPostProcessors" class="heading-link"><i class="fas fa-link"></i></a><a href="#invokeBeanFactoryPostProcessors" class="headerlink" title="invokeBeanFactoryPostProcessors"></a>invokeBeanFactoryPostProcessors</h5>
      <p><code>invokeBeanFactoryPostProcessors()</code>方法是这期的重点。实例化并调⽤实现了BeanFactoryPostProcessor接⼝的Bean，就是在这一步解析的<code>@SpringBootApplication</code>这个组合注解，BeanFactoryPostProcessor比较重要的一个<b>ConfigurationClassPostProcessor</b>在这里调用，用来遍历BeanDefinitionRegistry中现有的BeanDefinition解析<code>@Import</code>、<code>@Configuration</code>、<code>@ComponentScan</code>等注解将注解覆盖到的类也注册到BeanDefinitionRegistry中。</p>
<p>IOC容器初始化过程的三个步骤，也是在<code>invokeBeanFactoryPostProcessors</code>方法中完成。</p>
<blockquote>
<ul>
<li>BeanDefinition的Resource定位</li>
<li>BeanDefinition的载入</li>
<li>向IoC容器注册BeanDefinition</li>
</ul>
</blockquote>
<ul>
<li>第一步：Resource定位</li>
</ul>
<p>在SpringBoot中，我们都知道他的包扫描是从主类所在的包开始扫描的，prepareContext()方法中，会先将主类解析成BeanDefinition，然后在refresh()方法的invokeBeanFactoryPostProcessors()方法中解析主类的BeanDefinition获取basePackage的路径。这样就完成了定位的过程。其次SpringBoot的各种starter是通过SPI扩展机制实现的自动装配，SpringBoot的自动装配同样也是在invokeBeanFactoryPostProcessors()方法中实现的。还有一种情况，在SpringBoot中有很多的@EnableXXX注解，细心点进去看的应该就知道其底层是@Import注解，在invokeBeanFactoryPostProcessors()方法中也实现了对该注解指定的配置类的定位加载。</p>
<p>常规的在SpringBoot中有三种实现定位，第一个是主类所在包的，第二个是SPI扩展机制实现的自动装配（比如各种starter），第三种就是@Import注解指定的类。</p>
<ul>
<li>第二步：BeanDefinition的载入</li>
</ul>
<p>在第一步中说了三种Resource的定位情况，定位后紧接着就是BeanDefinition的分别载入。所谓的载入就是通过上面的定位得到的basePackage，SpringBoot会将该路径拼接成：<code>classpath*:org/springframework/boot/demo/**/*.class</code>这样的形式，然后一个叫做PathMatchingResourcePatternResolver的类会将该路径下所有的.class文件都加载进来，然后遍历判断是不是有@Component注解，如果有的话，就是我们要装载的BeanDefinition。</p>
<ul>
<li>第三个过程：注册BeanDefinition</li>
</ul>
<p>这个过程通过调用上文提到的BeanDefinitionRegister接口的实现来完成。这个注册过程把载入过程中解析得到的BeanDefinition向IoC容器进行注册。通过上文的分析，我们可以看到，在IoC容器中将BeanDefinition注入到一个ConcurrentHashMap中，IoC容器就是通过这个HashMap来持有这些BeanDefinition数据的。比如DefaultListableBeanFactory中的beanDefinitionMap属性。</p>
<p>具体看下代码实现过程</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">invokeBeanFactoryPostProcessors</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">    PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// PostProcessorRegistrationDelegate类</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeBeanFactoryPostProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// PostProcessorRegistrationDelegate类</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeBeanDefinitionRegistryPostProcessors</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        Collection&lt;? extends BeanDefinitionRegistryPostProcessor&gt; postProcessors, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (BeanDefinitionRegistryPostProcessor postProcessor : postProcessors) &#123;</span><br><span class="line">        postProcessor.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ConfigurationClassPostProcessor类</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    processConfigBeanDefinitions(registry);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ConfigurationClassPostProcessor类</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processConfigBeanDefinitions</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//Spring Boot项目的话，这里只有一个配置类就是我们的启动类</span></span><br><span class="line">    Set&lt;BeanDefinitionHolder&gt; candidates = <span class="keyword">new</span> LinkedHashSet(configCandidates);</span><br><span class="line">    HashSet alreadyParsed = <span class="keyword">new</span> HashSet(configCandidates.size());</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">    	  <span class="comment">//将解析出来的配置类@Configuration注解，封装成ConfigurationClass对象放入到parser.configurationClasses变量中</span></span><br><span class="line">          parser.parse(candidates);</span><br><span class="line">          parser.validate();</span><br><span class="line">          Set&lt;ConfigurationClass&gt; configClasses = <span class="keyword">new</span> LinkedHashSet(parser.getConfigurationClasses());</span><br><span class="line">          configClasses.removeAll(alreadyParsed);</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">this</span>.reader == <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="keyword">this</span>.reader = <span class="keyword">new</span> ConfigurationClassBeanDefinitionReader(registry, <span class="keyword">this</span>.sourceExtractor, <span class="keyword">this</span>.resourceLoader, <span class="keyword">this</span>.environment, <span class="keyword">this</span>.importBeanNameGenerator, parser.getImportRegistry());</span><br><span class="line">           &#125;</span><br><span class="line">          <span class="comment">//将解析配置类加载到容器中 	</span></span><br><span class="line">          <span class="keyword">this</span>.reader.loadBeanDefinitions(configClasses);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>走到<b>ConfigurationClassParser</b>类的<code>parse()</code>方法这里，包扫描及自动装配入口在这个方法里</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">(Set&lt;BeanDefinitionHolder&gt; configCandidates)</span> </span>&#123;</span><br><span class="line">    Iterator var2 = configCandidates.iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(var2.hasNext()) &#123;</span><br><span class="line">        BeanDefinitionHolder holder = (BeanDefinitionHolder)var2.next();</span><br><span class="line">        BeanDefinition bd = holder.getBeanDefinition();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        	<span class="comment">// 如果是SpringBoot项目进来的，bd其实就是前面主类封装成的 AnnotatedGenericBeanDefinition（AnnotatedBeanDefinition接口的实现类）</span></span><br><span class="line">            <span class="keyword">if</span> (bd <span class="keyword">instanceof</span> AnnotatedBeanDefinition) &#123;</span><br><span class="line">                <span class="keyword">this</span>.parse(((AnnotatedBeanDefinition)bd).getMetadata(), holder.getBeanName());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bd <span class="keyword">instanceof</span> AbstractBeanDefinition &amp;&amp; ((AbstractBeanDefinition)bd).hasBeanClass()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.parse(((AbstractBeanDefinition)bd).getBeanClass(), holder.getBeanName());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.parse(bd.getBeanClassName(), holder.getBeanName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BeanDefinitionStoreException var6) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var6;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var7) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(<span class="string">&quot;Failed to parse configuration class [&quot;</span> + bd.getBeanClassName() + <span class="string">&quot;]&quot;</span>, var7);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//加载默认的配置---》（对springboot项目来说这里就是自动装配的入口了）	</span></span><br><span class="line">    <span class="keyword">this</span>.deferredImportSelectorHandler.process();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="processConfigBeanDefinitions.jpg">
      </p>

        <h5 id="包扫描方式加载注册Bean">
          <a href="#包扫描方式加载注册Bean" class="heading-link"><i class="fas fa-link"></i></a><a href="#包扫描方式加载注册Bean" class="headerlink" title="包扫描方式加载注册Bean"></a>包扫描方式加载注册Bean</h5>
      
        <h6 id="第一步：Resource定位">
          <a href="#第一步：Resource定位" class="heading-link"><i class="fas fa-link"></i></a><a href="#第一步：Resource定位" class="headerlink" title="第一步：Resource定位"></a>第一步：Resource定位</h6>
      <p>沿着<code>this.parse(((AnnotatedBeanDefinition)bd).getMetadata(), holder.getBeanName());</code>追踪</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ConfigurationClassParser类</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">parse</span><span class="params">(AnnotationMetadata metadata, String beanName)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    processConfigurationClass(<span class="keyword">new</span> ConfigurationClass(metadata, beanName));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ConfigurationClassParser类</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">processConfigurationClass</span><span class="params">(ConfigurationClass configClass)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">	<span class="comment">//检查配置类上的@Conditional注解，如果不满足则直接跳过，若是已经导入的，则直接移除</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.conditionEvaluator.shouldSkip(configClass.getMetadata(), ConfigurationPhase.PARSE_CONFIGURATION)) &#123;</span><br><span class="line">            ConfigurationClass existingClass = (ConfigurationClass)<span class="keyword">this</span>.configurationClasses.get(configClass);</span><br><span class="line">            <span class="keyword">if</span> (existingClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (configClass.isImported()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (existingClass.isImported()) &#123;</span><br><span class="line">                        existingClass.mergeImportedBy(configClass);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>.configurationClasses.remove(configClass);</span><br><span class="line">                <span class="keyword">this</span>.knownSuperclasses.values().removeIf(configClass::equals);</span><br><span class="line">     &#125;</span><br><span class="line">    <span class="comment">// Recursively process the configuration class and its superclass hierarchy.</span></span><br><span class="line">    <span class="comment">//递归地处理配置类及其父类层次结构。</span></span><br><span class="line">    SourceClass sourceClass = asSourceClass(configClass);</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">//递归处理Bean，如果有父类，递归处理，直到顶层父类</span></span><br><span class="line">        sourceClass = doProcessConfigurationClass(configClass, sourceClass);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (sourceClass != <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.configurationClasses.put(configClass, configClass);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ConfigurationClassParser类</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> SourceClass <span class="title">doProcessConfigurationClass</span><span class="params">(ConfigurationClass configClass, SourceClass sourceClass)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Recursively process any member (nested) classes first</span></span><br><span class="line">    <span class="comment">//首先递归处理Component注解的内部类</span></span><br><span class="line"> 	<span class="keyword">if</span> (configClass.getMetadata().isAnnotated(Component.class.getName())) &#123;</span><br><span class="line">            <span class="keyword">this</span>.processMemberClasses(configClass, sourceClass);</span><br><span class="line">     &#125;</span><br><span class="line">    <span class="comment">// Process any @PropertySource annotations</span></span><br><span class="line">    <span class="comment">// 针对 @PropertySource 注解的属性配置处理</span></span><br><span class="line">    AnnotationAttributes importResource;</span><br><span class="line">        <span class="keyword">while</span>(var3.hasNext()) &#123;</span><br><span class="line">            importResource = (AnnotationAttributes)var3.next();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.environment <span class="keyword">instanceof</span> ConfigurableEnvironment) &#123;</span><br><span class="line">                <span class="keyword">this</span>.processPropertySource(importResource);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.logger.info(<span class="string">&quot;Ignoring @PropertySource annotation on [&quot;</span> + sourceClass.getMetadata().getClassName() + <span class="string">&quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process any @ComponentScan annotations</span></span><br><span class="line">    <span class="comment">// 根据 @ComponentScan 注解，扫描项目中的Bean（SpringBoot 启动类上有该注解）</span></span><br><span class="line">    Set&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(</span><br><span class="line">            sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);</span><br><span class="line">    <span class="keyword">if</span> (!componentScans.isEmpty() &amp;&amp;</span><br><span class="line">            !<span class="keyword">this</span>.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) &#123;</span><br><span class="line">        <span class="keyword">for</span> (AnnotationAttributes componentScan : componentScans) &#123;</span><br><span class="line">            <span class="comment">// The config class is annotated with @ComponentScan -&gt; perform the scan immediately</span></span><br><span class="line">            <span class="comment">// 立即执行扫描，（SpringBoot项目为什么是从主类所在的包扫描，这就是关键了）</span></span><br><span class="line">            Set&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions =</span><br><span class="line">                    <span class="keyword">this</span>.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());</span><br><span class="line">            <span class="comment">// Check the set of scanned definitions for any further config classes and parse recursively if needed</span></span><br><span class="line">            <span class="keyword">for</span> (BeanDefinitionHolder holder : scannedBeanDefinitions) &#123;</span><br><span class="line">                BeanDefinition bdCand = holder.getBeanDefinition().getOriginatingBeanDefinition();</span><br><span class="line">                <span class="keyword">if</span> (bdCand == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    bdCand = holder.getBeanDefinition();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 检查是否是ConfigurationClass（是否有configuration/component两个注解），如果是，递归查找该类相关联的配置类。</span></span><br><span class="line">                <span class="comment">// 所谓相关的配置类，比如@Configuration中的@Bean定义的bean。或者在有@Component注解的类上继续存在@Import注解。</span></span><br><span class="line">                <span class="keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, <span class="keyword">this</span>.metadataReaderFactory)) &#123;</span><br><span class="line">                    parse(bdCand.getBeanClassName(), holder.getBeanName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process any @Import annotations</span></span><br><span class="line">    <span class="comment">//递归处理 @Import 注解（SpringBoot项目中经常用的各种@Enable*** 注解基本都是封装的@Import）</span></span><br><span class="line">    processImports(configClass, sourceClass, getImports(sourceClass), <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process any @ImportResource annotations</span></span><br><span class="line">    AnnotationAttributes importResource =</span><br><span class="line">            AnnotationConfigUtils.attributesFor(sourceClass.getMetadata(), ImportResource.class);</span><br><span class="line">    <span class="keyword">if</span> (importResource != <span class="keyword">null</span>) &#123;</span><br><span class="line">        String[] resources = importResource.getStringArray(<span class="string">&quot;locations&quot;</span>);</span><br><span class="line">        Class&lt;? extends BeanDefinitionReader&gt; readerClass = importResource.getClass(<span class="string">&quot;reader&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (String resource : resources) &#123;</span><br><span class="line">            String resolvedResource = <span class="keyword">this</span>.environment.resolveRequiredPlaceholders(resource);</span><br><span class="line">            configClass.addImportedResource(resolvedResource, readerClass);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//解析@Bean注解</span></span><br><span class="line">    <span class="comment">// Process individual @Bean methods</span></span><br><span class="line">    Set&lt;MethodMetadata&gt; beanMethods = retrieveBeanMethodMetadata(sourceClass);</span><br><span class="line">    <span class="keyword">for</span> (MethodMetadata methodMetadata : beanMethods) &#123;</span><br><span class="line">        configClass.addBeanMethod(<span class="keyword">new</span> BeanMethod(methodMetadata, configClass));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process default methods on interfaces</span></span><br><span class="line">    processInterfaces(configClass, sourceClass);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process superclass, if any</span></span><br><span class="line">    <span class="keyword">if</span> (sourceClass.getMetadata().hasSuperClass()) &#123;</span><br><span class="line">        String superclass = sourceClass.getMetadata().getSuperClassName();</span><br><span class="line">        <span class="keyword">if</span> (superclass != <span class="keyword">null</span> &amp;&amp; !superclass.startsWith(<span class="string">&quot;java&quot;</span>) &amp;&amp;</span><br><span class="line">                !<span class="keyword">this</span>.knownSuperclasses.containsKey(superclass)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.knownSuperclasses.put(superclass, configClass);</span><br><span class="line">            <span class="comment">// Superclass found, return its annotation metadata and recurse</span></span><br><span class="line">            <span class="keyword">return</span> sourceClass.getSuperClass();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// No superclass -&gt; processing is complete</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>上面的<code>doProcessConfigurationClass()</code>方法是SpringBoot的包扫描的入口方法。</p>
<p><code>for (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable(...</code>获取主类上的@PropertySource注解，解析该注解并将该注解指定的properties配置文件中的值存储到Spring的Environment中，Environment接口提供方法去读取配置文件中的值，参数是properties文件中定义的key值。</p>
<p><code>Set&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable( sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class); </code>解析主类上的@ComponentScan注解。</p>
<p><code>parse(bdCand.getBeanClassName(), holder.getBeanName());</code>会进行递归调用，因为当Spring扫描到需要加载的类会进一步判断每一个类是否满足是<code>@Component/@Configuration</code>注解的类，如果满足会递归调用parse()方法，查找其相关的类。</p>
<p><code>processImports(configClass, sourceClass, getImports(sourceClass), true);</code>通过@Import注解查找到的类同样也会递归查找其相关的类。</p>
<p>我们看下<code>this.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());</code>扫描包过程</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ComponentScanAnnotationParser类</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;BeanDefinitionHolder&gt; <span class="title">parse</span><span class="params">(AnnotationAttributes componentScan, <span class="keyword">final</span> String declaringClass)</span> </span>&#123;</span><br><span class="line">    ClassPathBeanDefinitionScanner scanner = <span class="keyword">new</span> ClassPathBeanDefinitionScanner(<span class="keyword">this</span>.registry,</span><br><span class="line">            componentScan.getBoolean(<span class="string">&quot;useDefaultFilters&quot;</span>), <span class="keyword">this</span>.environment, <span class="keyword">this</span>.resourceLoader);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 根据 declaringClass （如果是SpringBoot项目，则参数为主类的全路径名）</span></span><br><span class="line">    <span class="keyword">if</span> (basePackages.isEmpty()) &#123;</span><br><span class="line">        basePackages.add(ClassUtils.getPackageName(declaringClass));</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 根据basePackages扫描类</span></span><br><span class="line">    <span class="keyword">return</span> scanner.doScan(StringUtils.toStringArray(basePackages));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>接着往下看<code>return scanner.doScan(StringUtils.toStringArray(basePackages));</code> Spring是如何进行类扫描的，进入doScan()方法。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ComponentScanAnnotationParser类</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Set&lt;BeanDefinitionHolder&gt; <span class="title">doScan</span><span class="params">(String... basePackages)</span> </span>&#123;</span><br><span class="line">    Assert.notEmpty(basePackages, <span class="string">&quot;At least one base package must be specified&quot;</span>);</span><br><span class="line">    Set&lt;BeanDefinitionHolder&gt; beanDefinitions = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (String basePackage : basePackages) &#123;</span><br><span class="line">        <span class="comment">// 从指定的包中扫描需要装载的Bean</span></span><br><span class="line">        Set&lt;BeanDefinition&gt; candidates = findCandidateComponents(basePackage);</span><br><span class="line">        <span class="keyword">for</span> (BeanDefinition candidate : candidates) &#123;</span><br><span class="line">            ScopeMetadata scopeMetadata = <span class="keyword">this</span>.scopeMetadataResolver.resolveScopeMetadata(candidate);</span><br><span class="line">            candidate.setScope(scopeMetadata.getScopeName());</span><br><span class="line">            String beanName = <span class="keyword">this</span>.beanNameGenerator.generateBeanName(candidate, <span class="keyword">this</span>.registry);</span><br><span class="line">            <span class="keyword">if</span> (candidate <span class="keyword">instanceof</span> AbstractBeanDefinition) &#123;</span><br><span class="line">                postProcessBeanDefinition((AbstractBeanDefinition) candidate, beanName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (candidate <span class="keyword">instanceof</span> AnnotatedBeanDefinition) &#123;</span><br><span class="line">                AnnotationConfigUtils.processCommonDefinitionAnnotations((AnnotatedBeanDefinition) candidate);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (checkCandidate(beanName, candidate)) &#123;</span><br><span class="line">                BeanDefinitionHolder definitionHolder = <span class="keyword">new</span> BeanDefinitionHolder(candidate, beanName);</span><br><span class="line">                definitionHolder =</span><br><span class="line">                        AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, <span class="keyword">this</span>.registry);</span><br><span class="line">                beanDefinitions.add(definitionHolder);</span><br><span class="line">                <span class="comment">//将该 Bean 注册进 IoC容器（beanDefinitionMap）</span></span><br><span class="line">                registerBeanDefinition(definitionHolder, <span class="keyword">this</span>.registry);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> beanDefinitions;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><code>doScan</code>中有两个比较重要的方法，<code>Set&lt;BeanDefinition&gt; candidates = findCandidateComponents(basePackage);</code> 从basePackage中扫描类并解析成BeanDefinition，拿到所有符合条件的类后在<code>registerBeanDefinition(definitionHolder, this.registry);</code> 将该类注册进IoC容器。也就是说在这个方法中完成了IoC容器初始化过程的第二、三步，BeanDefinition的载入和BeanDefinition的注册。</p>

        <h6 id="第二步：BeanDefinition载入-findCandidateComponents">
          <a href="#第二步：BeanDefinition载入-findCandidateComponents" class="heading-link"><i class="fas fa-link"></i></a><a href="#第二步：BeanDefinition载入-findCandidateComponents" class="headerlink" title="第二步：BeanDefinition载入-findCandidateComponents"></a>第二步：BeanDefinition载入-findCandidateComponents</h6>
      <p>我们看下<code>findCandidateComponents(basePackage);</code>代码<br> <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// ClassPathScanningCandidateComponentProvider类</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;BeanDefinition&gt; <span class="title">findCandidateComponents</span><span class="params">(String basePackage)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> scanCandidateComponents(basePackage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ClassPathScanningCandidateComponentProvider类</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Set&lt;BeanDefinition&gt; <span class="title">scanCandidateComponents</span><span class="params">(String basePackage)</span> </span>&#123;</span><br><span class="line">    Set&lt;BeanDefinition&gt; candidates = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//拼接扫描路径，比如：classpath*:org/springframework/boot/demo/**/*.class</span></span><br><span class="line">        String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX +</span><br><span class="line">                resolveBasePackage(basePackage) + <span class="string">&#x27;/&#x27;</span> + <span class="keyword">this</span>.resourcePattern;</span><br><span class="line">        <span class="comment">//从 packageSearchPath 路径中扫描所有的类 资源定位</span></span><br><span class="line">        Resource[] resources = getResourcePatternResolver().getResources(packageSearchPath);</span><br><span class="line">        <span class="keyword">boolean</span> traceEnabled = logger.isTraceEnabled();</span><br><span class="line">        <span class="keyword">boolean</span> debugEnabled = logger.isDebugEnabled();</span><br><span class="line">        <span class="keyword">for</span> (Resource resource : resources) &#123;</span><br><span class="line">            <span class="keyword">if</span> (traceEnabled) &#123;</span><br><span class="line">                logger.trace(<span class="string">&quot;Scanning &quot;</span> + resource);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (resource.isReadable()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    MetadataReader metadataReader = getMetadataReaderFactory().getMetadataReader(resource);</span><br><span class="line">                    <span class="comment">// //判断该类是不是 @Component 注解标注的类，并且不是需要排除掉的类</span></span><br><span class="line">                    <span class="keyword">if</span> (isCandidateComponent(metadataReader)) &#123;</span><br><span class="line">                        <span class="comment">//将该类封装成 ScannedGenericBeanDefinition（BeanDefinition接口的实现类）类</span></span><br><span class="line">                        ScannedGenericBeanDefinition sbd = <span class="keyword">new</span> ScannedGenericBeanDefinition(metadataReader);</span><br><span class="line">                        sbd.setResource(resource);</span><br><span class="line">                        sbd.setSource(resource);</span><br><span class="line">                        <span class="keyword">if</span> (isCandidateComponent(sbd)) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (debugEnabled) &#123;</span><br><span class="line">                                logger.debug(<span class="string">&quot;Identified candidate component class: &quot;</span> + resource);</span><br><span class="line">                            &#125;</span><br><span class="line">                            candidates.add(sbd);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (debugEnabled) &#123;</span><br><span class="line">                                logger.debug(<span class="string">&quot;Ignored because not a concrete top-level class: &quot;</span> + resource);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (traceEnabled) &#123;</span><br><span class="line">                            logger.trace(<span class="string">&quot;Ignored because not matching any filter: &quot;</span> + resource);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(</span><br><span class="line">                            <span class="string">&quot;Failed to read candidate component class: &quot;</span> + resource, ex);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (traceEnabled) &#123;</span><br><span class="line">                    logger.trace(<span class="string">&quot;Ignored because not readable: &quot;</span> + resource);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(<span class="string">&quot;I/O failure during classpath scanning&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> candidates;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure><br>在第13行将basePackage拼接成<code>classpath*:org/springframework/boot/demo/**/*.class</code>，在第16行的<code>getResources(packageSearchPath);</code>方法中扫描到了该路径下的所有的类。然后遍历这些Resources，在第27行判断该类是不是 <code>@Component</code>注解标注的类，并且不是需要排除掉的类。在第29行将扫描到的类，解析成<code>ScannedGenericBeanDefinition</code>，该类是BeanDefinition接口的实现类。</p>

        <h6 id="第三步：BeanDefinition注册">
          <a href="#第三步：BeanDefinition注册" class="heading-link"><i class="fas fa-link"></i></a><a href="#第三步：BeanDefinition注册" class="headerlink" title="第三步：BeanDefinition注册"></a>第三步：BeanDefinition注册</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)</span> </span>&#123;</span><br><span class="line">      BeanDefinitionReaderUtils.registerBeanDefinition(definitionHolder, registry);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>
<p>在<code>ComponentScanAnnotationParser#registerBeanDefinition</code>完成了BeanDefinition的注册，就完成了IoC容器的初始化过程。此时，在使用的IoC容器DefaultListableFactory中已经建立了整个Bean的配置信息，而这些BeanDefinition已经可以被容器使用了。他们都在BeanbefinitionMap里被检索和使用。容器的作用就是对这些信息进行处理和维护。这些信息是容器简历依赖反转的基础。</p>

        <h5 id="自动装配处理-DeferredImportSelector">
          <a href="#自动装配处理-DeferredImportSelector" class="heading-link"><i class="fas fa-link"></i></a><a href="#自动装配处理-DeferredImportSelector" class="headerlink" title="自动装配处理-DeferredImportSelector"></a>自动装配处理-DeferredImportSelector</h5>
      <p>1、预处理：deferredImportSelectorHandler.handle()<br>2、真正处理:deferredImportSelectorHandler.process()统一处理此次解析得到的所有DeferredImportSelector<br>3、ConfigurationClassPostProcessor#processConfigBeanDefinitions()中的<code>loadBeanDefinitions()</code>加载Bean</p>
<p>在<code>ConfigurationClassParser#parse()</code>中调用了<code>processImports()</code>对<code>@Import</code>注解进行解析。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processImports</span><span class="params">(ConfigurationClass configClass, ConfigurationClassParser.SourceClass currentSourceClass, Collection&lt;ConfigurationClassParser.SourceClass&gt; importCandidates, <span class="keyword">boolean</span> checkForCircularImports)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!importCandidates.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (checkForCircularImports &amp;&amp; <span class="keyword">this</span>.isChainedImportOnStack(configClass)) &#123;</span><br><span class="line">                <span class="keyword">this</span>.problemReporter.error(<span class="keyword">new</span> ConfigurationClassParser.CircularImportProblem(configClass, <span class="keyword">this</span>.importStack));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.importStack.push(configClass);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Iterator var5 = importCandidates.iterator();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span>(var5.hasNext()) &#123;</span><br><span class="line">                        ConfigurationClassParser.SourceClass candidate = (ConfigurationClassParser.SourceClass)var5.next();</span><br><span class="line">                        Class candidateClass;</span><br><span class="line">                        <span class="keyword">if</span> (candidate.isAssignable(ImportSelector.class)) &#123;</span><br><span class="line">                            candidateClass = candidate.loadClass();</span><br><span class="line">                            ImportSelector selector = (ImportSelector)BeanUtils.instantiateClass(candidateClass, ImportSelector.class);</span><br><span class="line">                            ParserStrategyUtils.invokeAwareMethods(selector, <span class="keyword">this</span>.environment, <span class="keyword">this</span>.resourceLoader, <span class="keyword">this</span>.registry);</span><br><span class="line">                            <span class="comment">//用于Spring Boot自动装配 当所有配置类处理完才执行</span></span><br><span class="line">                            <span class="keyword">if</span> (selector <span class="keyword">instanceof</span> DeferredImportSelector) &#123;</span><br><span class="line">                                <span class="keyword">this</span>.deferredImportSelectorHandler.handle(configClass, (DeferredImportSelector)selector);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                String[] importClassNames = selector.selectImports(currentSourceClass.getMetadata());</span><br><span class="line">                                Collection&lt;ConfigurationClassParser.SourceClass&gt; importSourceClasses = <span class="keyword">this</span>.asSourceClasses(importClassNames);</span><br><span class="line">                                <span class="keyword">this</span>.processImports(configClass, currentSourceClass, importSourceClasses, <span class="keyword">false</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (candidate.isAssignable(ImportBeanDefinitionRegistrar.class)) &#123;</span><br><span class="line">                            candidateClass = candidate.loadClass();</span><br><span class="line">                            ImportBeanDefinitionRegistrar registrar = (ImportBeanDefinitionRegistrar)BeanUtils.instantiateClass(candidateClass, ImportBeanDefinitionRegistrar.class);</span><br><span class="line">                            ParserStrategyUtils.invokeAwareMethods(registrar, <span class="keyword">this</span>.environment, <span class="keyword">this</span>.resourceLoader, <span class="keyword">this</span>.registry);</span><br><span class="line">                            configClass.addImportBeanDefinitionRegistrar(registrar, currentSourceClass.getMetadata());</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">this</span>.importStack.registerImport(currentSourceClass.getMetadata(), candidate.getMetadata().getClassName());</span><br><span class="line">                            <span class="keyword">this</span>.processConfigurationClass(candidate.asConfigClass(configClass));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (BeanDefinitionStoreException var15) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> var15;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var16) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(<span class="string">&quot;Failed to process import candidates for configuration class [&quot;</span> + configClass.getMetadata().getClassName() + <span class="string">&quot;]&quot;</span>, var16);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.importStack.pop();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>
<p>在上面的方法中<code>this.deferredImportSelectorHandler.handle(configClass, (DeferredImportSelector)selector);</code>将当前的configClass放到<code>deferredImportSelectorHandler</code>，留着之后处理。</p>

        <h6 id="预处理：deferredImportSelectorHandler-handle">
          <a href="#预处理：deferredImportSelectorHandler-handle" class="heading-link"><i class="fas fa-link"></i></a><a href="#预处理：deferredImportSelectorHandler-handle" class="headerlink" title="预处理：deferredImportSelectorHandler.handle()"></a>预处理：deferredImportSelectorHandler.handle()</h6>
      <p>进入到<code>handle()</code>方法查看下</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">DeferredImportSelectorHandler</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Nullable</span></span><br><span class="line">        <span class="keyword">private</span> List&lt;ConfigurationClassParser.DeferredImportSelectorHolder&gt; deferredImportSelectors;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">DeferredImportSelectorHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.deferredImportSelectors = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(ConfigurationClass configClass, DeferredImportSelector importSelector)</span> </span>&#123;</span><br><span class="line">            ConfigurationClassParser.DeferredImportSelectorHolder holder = <span class="keyword">new</span> ConfigurationClassParser.DeferredImportSelectorHolder(configClass, importSelector);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.deferredImportSelectors == <span class="keyword">null</span>) &#123;</span><br><span class="line">                ConfigurationClassParser.DeferredImportSelectorGroupingHandler handler = ConfigurationClassParser.<span class="keyword">this</span>.<span class="function">new <span class="title">DeferredImportSelectorGroupingHandler</span><span class="params">()</span></span>;</span><br><span class="line">                handler.register(holder);</span><br><span class="line">                handler.processGroupImports();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.deferredImportSelectors.add(holder);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">&#125;        </span><br></pre></td></tr></table></div></figure>
<p>在<code>ConfigurationClassParser#parse()</code>中执行完<code>parse(((AnnotatedBeanDefinition)bd).getMetadata(), holder.getBeanName())</code>后，这时所有的类都已经处理完毕，才执行<code>this.deferredImportSelectorHandler.process();</code></p>

        <h6 id="真正处理-deferredImportSelectorHandler-process">
          <a href="#真正处理-deferredImportSelectorHandler-process" class="heading-link"><i class="fas fa-link"></i></a><a href="#真正处理-deferredImportSelectorHandler-process" class="headerlink" title="真正处理:deferredImportSelectorHandler.process()"></a>真正处理:deferredImportSelectorHandler.process()</h6>
      <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">DeferredImportSelectorHandler</span> </span>&#123;</span><br><span class="line">       <span class="meta">@Nullable</span></span><br><span class="line">       <span class="keyword">private</span> List&lt;ConfigurationClassParser.DeferredImportSelectorHolder&gt; deferredImportSelectors;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">private</span> <span class="title">DeferredImportSelectorHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">this</span>.deferredImportSelectors = <span class="keyword">new</span> ArrayList();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           List&lt;ConfigurationClassParser.DeferredImportSelectorHolder&gt; deferredImports = <span class="keyword">this</span>.deferredImportSelectors;</span><br><span class="line">           <span class="keyword">this</span>.deferredImportSelectors = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> (deferredImports != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   ConfigurationClassParser.DeferredImportSelectorGroupingHandler handler = ConfigurationClassParser.<span class="keyword">this</span>.n<span class="function">ew <span class="title">DeferredImportSelectorGroupingHandler</span><span class="params">()</span></span>;</span><br><span class="line">                   deferredImports.sort(ConfigurationClassParser.DEFERRED_IMPORT_COMPARATOR);</span><br><span class="line">                   deferredImports.forEach(handler::register);</span><br><span class="line">                   handler.processGroupImports();</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">               <span class="keyword">this</span>.deferredImportSelectors = <span class="keyword">new</span> ArrayList();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>
<p>DeferredImportSelectorHolder会根据Group进行分组，来区分不同的ImportSelector，比如我们这个项目的AutoConfigurationImportSelector是属于AutoConfigurationGroup类型的。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">DeferredImportSelectorGroupingHandler</span> </span>&#123;</span><br><span class="line">		<span class="comment">// key：组类型（在这里 AutoConfigurationGroup） value：组</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, ConfigurationClassParser.DeferredImportSelectorGrouping&gt; groupings;</span><br><span class="line">        <span class="comment">// key：配置类的注解属性 value：配置类信息（在这里是 AppBootstrap 的信息）</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;AnnotationMetadata, ConfigurationClass&gt; configurationClasses;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">DeferredImportSelectorGroupingHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.groupings = <span class="keyword">new</span> LinkedHashMap();</span><br><span class="line">            <span class="keyword">this</span>.configurationClasses = <span class="keyword">new</span> HashMap();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(ConfigurationClassParser.DeferredImportSelectorHolder deferredImport)</span> </span>&#123;</span><br><span class="line">        	<span class="comment">// 调用org.springframework.boot.autoconfigure.AutoConfigurationImportSelector.getImportGroup 返回AutoConfigurationGroup.class</span></span><br><span class="line">            Class&lt;? extends Group&gt; group = deferredImport.getImportSelector().getImportGroup();</span><br><span class="line">            <span class="comment">// 创建Group对象, 用DeferredImportSelectorGrouping包装并存入到m</span></span><br><span class="line">            ConfigurationClassParser.DeferredImportSelectorGrouping grouping = (ConfigurationClassParser.DeferredImportSelectorGrouping)<span class="keyword">this</span>.groupings.computeIfAbsent(group != <span class="keyword">null</span> ? group : deferredImport, (key) -&gt; &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ConfigurationClassParser.DeferredImportSelectorGrouping(<span class="keyword">this</span>.createGroup(group));</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="comment">// 向deferredImports对象添加元素, 后面</span></span><br><span class="line">            grouping.add(deferredImport);</span><br><span class="line">            <span class="comment">// 存入map中 key为启动类的元数据 value是启动类</span></span><br><span class="line">            <span class="keyword">this</span>.configurationClasses.put(deferredImport.getConfigurationClass().getMetadata(), deferredImport.getConfigurationClass());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processGroupImports</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Iterator var1 = <span class="keyword">this</span>.groupings.values().iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var1.hasNext()) &#123;</span><br><span class="line">                ConfigurationClassParser.DeferredImportSelectorGrouping grouping = (ConfigurationClassParser.DeferredImportSelectorGrouping)var1.next();</span><br><span class="line">                grouping.getImports().forEach((entry) -&gt; &#123;</span><br><span class="line">                     <span class="comment">// 获取主配置类 启动类</span></span><br><span class="line">                    ConfigurationClass configurationClass = (ConfigurationClass)<span class="keyword">this</span>.configurationClasses.get(entry.getMetadata());</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                    	 <span class="comment">// 逐个执行导入 至此执行完成后, 扫描出的类都会注册到BeanDefinition中 等待Spring容器对对象实例化和初始化</span></span><br><span class="line">                        ConfigurationClassParser.<span class="keyword">this</span>.processImports(configurationClass, ConfigurationClassParser.<span class="keyword">this</span>.asSourceClass(configurationClass), ConfigurationClassParser.<span class="keyword">this</span>.asSourceClasses(entry.getImportClassName()), <span class="keyword">false</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (BeanDefinitionStoreException var4) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> var4;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable var5) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionStoreException(<span class="string">&quot;Failed to process import candidates for configuration class [&quot;</span> + configurationClass.getMetadata().getClassName() + <span class="string">&quot;]&quot;</span>, var5);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> Group <span class="title">createGroup</span><span class="params">(<span class="meta">@Nullable</span> Class&lt;? extends Group&gt; type)</span> </span>&#123;</span><br><span class="line">            Class&lt;? extends Group&gt; effectiveType = type != <span class="keyword">null</span> ? type : ConfigurationClassParser.DefaultDeferredImportSelectorGroup.class;</span><br><span class="line">            Group group = (Group)BeanUtils.instantiateClass(effectiveType);</span><br><span class="line">            ParserStrategyUtils.invokeAwareMethods(group, ConfigurationClassParser.<span class="keyword">this</span>.environment, ConfigurationClassParser.<span class="keyword">this</span>.resourceLoader, ConfigurationClassParser.<span class="keyword">this</span>.registry);</span><br><span class="line">            <span class="keyword">return</span> group;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>
<p>在<code>processGroupImports()</code>中，<code>getImports()</code>返回的<code>Entry</code>,Entry保存着要导入的类和导入此类的配置类的注解信息，如下：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Entry</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 引入当前类的配置类元数据，这里就是 appBootstrap 的注解元数据</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AnnotationMetadata metadata;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 引入类的全类名，例如：org.springframework.boot.autoconfigure.context.MessageSourceAutoConfiguration</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String importClassName;</span><br></pre></td></tr></table></div></figure>
<p>我们接着看<code>grouping.getImports()</code>方法。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DeferredImportSelectorGrouping</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Group group;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ConfigurationClassParser.DeferredImportSelectorHolder&gt; deferredImports = <span class="keyword">new</span> ArrayList();</span><br><span class="line"></span><br><span class="line">        DeferredImportSelectorGrouping(Group group) &#123;</span><br><span class="line">            <span class="keyword">this</span>.group = group;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(ConfigurationClassParser.DeferredImportSelectorHolder deferredImport)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.deferredImports.add(deferredImport);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Iterable&lt;Entry&gt; <span class="title">getImports</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Iterator var1 = <span class="keyword">this</span>.deferredImports.iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var1.hasNext()) &#123;</span><br><span class="line">                ConfigurationClassParser.DeferredImportSelectorHolder deferredImport = (ConfigurationClassParser.DeferredImportSelectorHolder)var1.next();</span><br><span class="line">                <span class="comment">//group为AutoConfigurationGroup对象执行org.springframework.boot.autoconfigure.AutoConfigurationImportSelector.AutoConfigurationGroup.process方法</span></span><br><span class="line">                <span class="comment">//deferredImport.getConfigurationClass().getMetadata()获取类路径META-INF/spring-autoconfigure-metadata.properties下的元数据信息</span></span><br><span class="line">                <span class="keyword">this</span>.group.process(deferredImport.getConfigurationClass().getMetadata(), deferredImport.getImportSelector());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.group.selectImports();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>
<p>这里的group对应由<code>deferredImports.forEach(handler::register);</code>注册进来，对应为<b>AutoConfigurationGroup</b>。上述方法中调用的<code>process</code>和<code>selectImports</code>，其实是调用的是<b>AutoConfigurationGroup#process()</b>、<b>AutoConfigurationGroup#selectImports()</b>。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoConfigurationGroup</span> <span class="keyword">implements</span> <span class="title">Group</span>, <span class="title">BeanClassLoaderAware</span>, <span class="title">BeanFactoryAware</span>, <span class="title">ResourceLoaderAware</span> </span>&#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, AnnotationMetadata&gt; entries = <span class="keyword">new</span> LinkedHashMap();</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> List&lt;AutoConfigurationImportSelector.AutoConfigurationEntry&gt; autoConfigurationEntries = <span class="keyword">new</span> ArrayList();</span><br><span class="line">       <span class="keyword">private</span> ClassLoader beanClassLoader;</span><br><span class="line">       <span class="keyword">private</span> BeanFactory beanFactory;</span><br><span class="line">       <span class="keyword">private</span> ResourceLoader resourceLoader;</span><br><span class="line">       <span class="keyword">private</span> AutoConfigurationMetadata autoConfigurationMetadata;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">private</span> <span class="title">AutoConfigurationGroup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanClassLoader</span><span class="params">(ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">this</span>.beanClassLoader = classLoader;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanFactory</span><span class="params">(BeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResourceLoader</span><span class="params">(ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(AnnotationMetadata annotationMetadata, DeferredImportSelector deferredImportSelector)</span> </span>&#123;</span><br><span class="line">           Assert.state(deferredImportSelector <span class="keyword">instanceof</span> AutoConfigurationImportSelector, () -&gt; &#123;</span><br><span class="line">               <span class="keyword">return</span> String.format(<span class="string">&quot;Only %s implementations are supported, got %s&quot;</span>, AutoConfigurationImportSelector.class.getSimpleName(), deferredImportSelector.getClass().getName());</span><br><span class="line">           &#125;);</span><br><span class="line">           AutoConfigurationImportSelector.AutoConfigurationEntry autoConfigurationEntry = ((AutoConfigurationImportSelector)deferredImportSelector).getAutoConfigurationEntry(<span class="keyword">this</span>.getAutoConfigurationMetadata(), annotationMetadata);</span><br><span class="line">           <span class="keyword">this</span>.autoConfigurationEntries.add(autoConfigurationEntry);</span><br><span class="line">           Iterator var4 = autoConfigurationEntry.getConfigurations().iterator();</span><br><span class="line"></span><br><span class="line">           <span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">               String importClassName = (String)var4.next();</span><br><span class="line">               <span class="keyword">this</span>.entries.putIfAbsent(importClassName, annotationMetadata);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> Iterable&lt;Entry&gt; <span class="title">selectImports</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">this</span>.autoConfigurationEntries.isEmpty()) &#123;</span><br><span class="line">               <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               Set&lt;String&gt; allExclusions = (Set)<span class="keyword">this</span>.autoConfigurationEntries.stream().map(AutoConfigurationImportSelector.AutoConfigurationEntry::getExclusions).flatMap(Collection::stream).collect(Collectors.toSet());</span><br><span class="line">               Set&lt;String&gt; processedConfigurations = (Set)<span class="keyword">this</span>.autoConfigurationEntries.stream().map(AutoConfigurationImportSelector.AutoConfigurationEntry::getConfigurations).flatMap(Collection::stream).collect(Collectors.toCollection(LinkedHashSet::<span class="keyword">new</span>));</span><br><span class="line">               processedConfigurations.removeAll(allExclusions);</span><br><span class="line">               <span class="keyword">return</span> (Iterable)<span class="keyword">this</span>.sortAutoConfigurations(processedConfigurations, <span class="keyword">this</span>.getAutoConfigurationMetadata()).stream().map((importClassName) -&gt; &#123;</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">new</span> Entry((AnnotationMetadata)<span class="keyword">this</span>.entries.get(importClassName), importClassName);</span><br><span class="line">               &#125;).collect(Collectors.toList());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><b>AutoConfigurationGroup#process()</b>负责加载<code>spring.factories</code>文件中的配置类，并按条件进行过滤，而<b>AutoConfigurationGroup#selectImports()<b>返回最终的配置实现类集合。</b></b></p>

        <h6 id="加载Bean">
          <a href="#加载Bean" class="heading-link"><i class="fas fa-link"></i></a><a href="#加载Bean" class="headerlink" title="加载Bean"></a>加载Bean</h6>
      <p>ConfigurationClassPostProcessor#processConfigBeanDefinitions()中的<code>loadBeanDefinitions()</code>完成配置类bean加载。</p>

        <h6 id="小结-1">
          <a href="#小结-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#小结-1" class="headerlink" title="小结"></a>小结</h6>
      <p>综上可以看到<code>DeferredImportSelector</code>的处理过程并非是直接 调用<code>ImportSelector#selectImports</code>方法。而是调用<code>DeferredImportSelector.Group#process</code>和<code>DeferredImportSelector.Group#selectImports</code>方法来完成引入功能。</p>
<p>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="refresh.jpg">
      </p>

        <h3 id="参考资料">
          <a href="#参考资料" class="heading-link"><i class="fas fa-link"></i></a><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3>
      <ul>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.cnblogs.com/hujesse4/p/14755562.html#_label2">springboot自动装配原理【超详细】</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.cnblogs.com/hello-shf/p/10976646.html">SpringBoot启动流程分析（一）：SpringApplication类初始化过程</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://blog.csdn.net/yangxiaofei_java/article/details/113829472">SpringBoot启动流程原理+自动装配原理</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.cnblogs.com/chenxingyang/p/15440519.html">Spring处理配置类大致过程</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://my.oschina.net/funcy/blog/4873261">springboot 源码分析系列文章汇总</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="https://focusss.github.io">大湾区码仔驰名商标</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="https://focusss.github.io/2022/03/26/Spring-Boot%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%8F%8A%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E5%8E%9F%E7%90%86/">https://focusss.github.io/2022/03/26/Spring-Boot%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%E5%8F%8A%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E5%8E%9F%E7%90%86/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://focusss.github.io/tags/Java/">Java</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://focusss.github.io/tags/SPI/">SPI</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2022/03/26/SPI%E6%9C%BA%E5%88%B6/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">SPI机制</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2022/03/23/Redis-%E5%AD%97%E5%85%B8/"><span class="paginator-prev__text">Redis 字典</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">
          简述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-Boot%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E5%8E%9F%E7%90%86%EF%BC%88%E4%BB%8E%E6%B3%A8%E8%A7%A3-SpringBootApplication%E5%85%A5%E6%89%8B%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">
          Spring Boot自动装配原理（从注解@SpringBootApplication入手）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SpringBootConfiguration"><span class="toc-number">2.1.</span> <span class="toc-text">
          @SpringBootConfiguration</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EnableAutoConfiguration"><span class="toc-number">2.2.</span> <span class="toc-text">
          @EnableAutoConfiguration</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#AutoConfigurationPackage"><span class="toc-number">2.2.1.</span> <span class="toc-text">
          @AutoConfigurationPackage</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Import-AutoConfigurationImportSelector-class"><span class="toc-number">2.2.2.</span> <span class="toc-text">
          @Import({AutoConfigurationImportSelector.class})</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ComponentScan"><span class="toc-number">2.3.</span> <span class="toc-text">
          @ComponentScan</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">2.4.</span> <span class="toc-text">
          小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring-Boot%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B%EF%BC%88%E4%BB%8E%E4%BB%A3%E7%A0%81run-%E5%85%A5%E6%89%8B%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">
          Spring Boot启动过程（从代码run()入手）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BASpringApplication%E5%AE%9E%E4%BE%8B"><span class="toc-number">3.1.</span> <span class="toc-text">
          创建SpringApplication实例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#deduceFromClasspath-%E6%8E%A8%E6%96%AD%E5%BA%94%E7%94%A8%E7%9A%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.1.1.</span> <span class="toc-text">
          deduceFromClasspath()-推断应用的类型</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#run%E6%96%B9%E6%B3%95%E9%80%BB%E8%BE%91"><span class="toc-number">3.2.</span> <span class="toc-text">
          run方法逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E8%8E%B7%E5%8F%96%E5%B9%B6%E5%90%AF%E5%8A%A8%E7%9B%91%E5%90%AC%E5%99%A8"><span class="toc-number">3.2.1.</span> <span class="toc-text">
          第一步：获取并启动监听器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E9%85%8D%E7%BD%AE%E9%A1%B9%E7%9B%AE%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">3.2.2.</span> <span class="toc-text">
          第二步：配置项目运行环境</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#configureEnvironment-ConfigurableEnvironment-environment-String-args"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">
          configureEnvironment(ConfigurableEnvironment environment, String[] args)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#listeners-environmentPrepared-ConfigurableEnvironment-environment"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">
          listeners.environmentPrepared((ConfigurableEnvironment)environment)</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9A%E5%88%9B%E5%BB%BASpring%E5%AE%B9%E5%99%A8"><span class="toc-number">3.2.3.</span> <span class="toc-text">
          第三步：创建Spring容器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5%EF%BC%9ASpring%E5%AE%B9%E5%99%A8%E5%89%8D%E7%BD%AE%E5%A4%84%E7%90%86%EF%BC%88%E5%85%B3%E9%94%AE%EF%BC%89"><span class="toc-number">3.2.4.</span> <span class="toc-text">
          第四步：Spring容器前置处理（关键）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E6%AD%A5%EF%BC%9A%E5%88%B7%E6%96%B0%E5%AE%B9%E5%99%A8%EF%BC%88%E5%85%B3%E9%94%AE%EF%BC%89"><span class="toc-number">3.2.5.</span> <span class="toc-text">
          第五步：刷新容器（关键）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#invokeBeanFactoryPostProcessors"><span class="toc-number">3.2.6.</span> <span class="toc-text">
          invokeBeanFactoryPostProcessors</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8C%85%E6%89%AB%E6%8F%8F%E6%96%B9%E5%BC%8F%E5%8A%A0%E8%BD%BD%E6%B3%A8%E5%86%8CBean"><span class="toc-number">3.2.7.</span> <span class="toc-text">
          包扫描方式加载注册Bean</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9AResource%E5%AE%9A%E4%BD%8D"><span class="toc-number">3.2.7.1.</span> <span class="toc-text">
          第一步：Resource定位</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9ABeanDefinition%E8%BD%BD%E5%85%A5-findCandidateComponents"><span class="toc-number">3.2.7.2.</span> <span class="toc-text">
          第二步：BeanDefinition载入-findCandidateComponents</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%EF%BC%9ABeanDefinition%E6%B3%A8%E5%86%8C"><span class="toc-number">3.2.7.3.</span> <span class="toc-text">
          第三步：BeanDefinition注册</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E5%A4%84%E7%90%86-DeferredImportSelector"><span class="toc-number">3.2.8.</span> <span class="toc-text">
          自动装配处理-DeferredImportSelector</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%A2%84%E5%A4%84%E7%90%86%EF%BC%9AdeferredImportSelectorHandler-handle"><span class="toc-number">3.2.8.1.</span> <span class="toc-text">
          预处理：deferredImportSelectorHandler.handle()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%9C%9F%E6%AD%A3%E5%A4%84%E7%90%86-deferredImportSelectorHandler-process"><span class="toc-number">3.2.8.2.</span> <span class="toc-text">
          真正处理:deferredImportSelectorHandler.process()</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BDBean"><span class="toc-number">3.2.8.3.</span> <span class="toc-text">
          加载Bean</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-1"><span class="toc-number">3.2.8.4.</span> <span class="toc-text">
          小结</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">4.</span> <span class="toc-text">
          参考资料</span></a></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/headImg.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">平安大赚 财丁兴旺</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">88</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">26</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">36</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2022</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>大湾区码仔驰名商标</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.4.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__info">访问人数</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__info">浏览总量</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/ribbon.js@latest/dist/ribbon.min.js" size="120" alpha="0.6" zIndex="-1"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-rc.2/lazyload.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="https://cdn.jsdelivr.net/npm/pjax@latest/pjax.min.js"></script><script>window.addEventListener('DOMContentLoaded', function () {
  var pjax = new Pjax({"selectors":["head title","#main",".pjax-reload"],"history":true,"scrollTo":false,"scrollRestoration":false,"cacheBust":false,"debug":false,"currentUrlFullReload":false,"timeout":0});
  // 加载进度条的计时器
  var loadingTimer = null;

  // 重置页面 Y 方向上的滚动偏移量
  document.addEventListener('pjax:send', function () {
    $('.header-nav-menu').removeClass('show');
    if (CONFIG.pjax && CONFIG.pjax.avoidBanner) {
      $('html').velocity('scroll', {
        duration: 500,
        offset: $('#header').height(),
        easing: 'easeInOutCubic'
      });
    }

    var loadingBarWidth = 20;
    var MAX_LOADING_WIDTH = 95;

    $('.loading-bar').addClass('loading');
    $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    clearInterval(loadingTimer);
    loadingTimer = setInterval(function () {
      loadingBarWidth += 3;
      if (loadingBarWidth > MAX_LOADING_WIDTH) {
        loadingBarWidth = MAX_LOADING_WIDTH;
      }
      $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    }, 500);
  }, false);

  window.addEventListener('pjax:complete', function () {
    clearInterval(loadingTimer);
    $('.loading-bar__progress').css('width', '100%');
    $('.loading-bar').removeClass('loading');
    setTimeout(function () {
      $('.loading-bar__progress').css('width', '0');
    }, 400);
    $('link[rel=prefetch], script[data-pjax-rm]').each(function () {
      $(this).remove();
    });
    $('script[data-pjax], #pjax-reload script').each(function () {
      $(this).parent().append($(this).remove());
    });

    if (Stun.utils.pjaxReloadBoot) {
      Stun.utils.pjaxReloadBoot();
    }
    if (Stun.utils.pjaxReloadScroll) {
      Stun.utils.pjaxReloadScroll();
    }
    if (Stun.utils.pjaxReloadSidebar) {
      Stun.utils.pjaxReloadSidebar();
    }
    if (false) {
      if (Stun.utils.pjaxReloadHeader) {
        Stun.utils.pjaxReloadHeader();
      }
      if (Stun.utils.pjaxReloadScrollIcon) {
        Stun.utils.pjaxReloadScrollIcon();
      }
      if (Stun.utils.pjaxReloadLocalSearch) {
        Stun.utils.pjaxReloadLocalSearch();
      }
    }
  }, false);
}, false);</script><div id="pjax-reload"><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script></div><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script></body></html>