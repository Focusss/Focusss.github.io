<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta name="description" content="nacos客户端会循环请求服务端变更的数据，并且超时时间设置为30s，当配置发生变化时，请求的响应会立即返回，否则会一直等到 29.5s+ 之后再返回响应。nacos 客户端能够实时感知到服务端配置发生了变化，实时感知是建立在客户端拉和服务端推的基础上。">
<meta property="og:type" content="article">
<meta property="og:title" content="nacos 动态配置机制">
<meta property="og:url" content="https://focusss.github.io/2022/03/30/nacos-%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E6%9C%BA%E5%88%B6/index.html">
<meta property="og:site_name" content="大 湾 区 码 仔&#39;s Blog">
<meta property="og:description" content="nacos客户端会循环请求服务端变更的数据，并且超时时间设置为30s，当配置发生变化时，请求的响应会立即返回，否则会一直等到 29.5s+ 之后再返回响应。nacos 客户端能够实时感知到服务端配置发生了变化，实时感知是建立在客户端拉和服务端推的基础上。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://focusss.github.io/2022/03/30/nacos-%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E6%9C%BA%E5%88%B6/clientLongPoll.png">
<meta property="og:image" content="https://focusss.github.io/2022/03/30/nacos-%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E6%9C%BA%E5%88%B6/nacosUpdate.png">
<meta property="article:published_time" content="2022-03-30T03:57:25.000Z">
<meta property="article:modified_time" content="2022-05-09T15:10:16.320Z">
<meta property="article:author" content="大湾区码仔驰名商标">
<meta property="article:tag" content="nacos">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://focusss.github.io/2022/03/30/nacos-%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E6%9C%BA%E5%88%B6/clientLongPoll.png"><title>nacos 动态配置机制 | 大 湾 区 码 仔's Blog</title><link ref="canonical" href="https://focusss.github.io/2022/03/30/nacos-%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E6%9C%BA%E5%88%B6/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":true},
  reward: false,
  fancybox: true,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: true,
  pjax: {"avoidBanner":false},
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.4.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/categories/"><span class="header-nav-menu-item__icon"><i class="fas fa-layer-group"></i></span><span class="header-nav-menu-item__text">分类</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div></div><div class="header-nav-search"><span class="header-nav-search__icon"><i class="fas fa-search"></i></span><span class="header-nav-search__text">搜索</span></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">大 湾 区 码 仔's Blog</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">nacos 动态配置机制</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2022-03-30</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2022-05-09</span></span><span class="post-meta-item post-meta-item--visitors"><span class="post-meta-item__icon"><i class="fas fa-eye"></i></span><span class="post-meta-item__info">阅读次数</span><span class="post-meta-item__value" id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body">
        <h3 id="nacos-config配置中心使用">
          <a href="#nacos-config配置中心使用" class="heading-link"><i class="fas fa-link"></i></a><a href="#nacos-config配置中心使用" class="headerlink" title="nacos config配置中心使用"></a>nacos config配置中心使用</h3>
      
        <h4 id="引入nacos-config-starter">
          <a href="#引入nacos-config-starter" class="heading-link"><i class="fas fa-link"></i></a><a href="#引入nacos-config-starter" class="headerlink" title="引入nacos config starter"></a>引入nacos config starter</h4>
      <figure class="highlight xml"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></div></figure>
<p>然后在bootstrap.yml添加对应的nacos连接配置信息即可</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: cn-bullet-demo-rest</span><br><span class="line">  cloud:</span><br><span class="line">    nacos:</span><br><span class="line">      config:</span><br><span class="line">        file-extension: yml</span><br><span class="line">        shared-dataids: cn-bullet-common.yml</span><br><span class="line">        refreshable-dataids: $&#123;spring.cloud.nacos.config.shared-dataids&#125;,$&#123;spring.application.name&#125;.yml</span><br><span class="line">        ext-config[0]:</span><br><span class="line">          data-id: $&#123;spring.application.name&#125;-redisson.yml</span><br><span class="line">          refresh: true</span><br><span class="line">        server-addr: $&#123;DISCOVERY_ADDRESS:127.0.0.1&#125;:8848</span><br><span class="line">        namespace: $&#123;DISCOVERY_NAMESPACE:dev&#125;</span><br><span class="line">      discovery:</span><br><span class="line">        server-addr: $&#123;DISCOVERY_ADDRESS:127.0.0.1&#125;:8848</span><br><span class="line">        namespace: $&#123;DISCOVERY_NAMESPACE:dev&#125;</span><br></pre></td></tr></table></div></figure>
<p>另外还需要在nacos上新建cn-bullet-demo-rest.yml配置文件的内容。</p>

        <h4 id="配置文件-bootstrap和application区别">
          <a href="#配置文件-bootstrap和application区别" class="heading-link"><i class="fas fa-link"></i></a><a href="#配置文件-bootstrap和application区别" class="headerlink" title="配置文件 bootstrap和application区别"></a>配置文件 bootstrap和application区别</h4>
      <p>Spring Cloud 构建于 Spring Boot 之上，在 Spring Boot 中有两种上下文，一种是 bootstrap， 另外一种是 application。 bootstrap 是应用程序的父上下文，也就是说 bootstrap 加载优先于 applicaton。bootstrap主要用于从额外的资源来加载配置信息，还可以在本地外部配置文件中解密属性。这两个上下文共用一个环境，它是任何Spring应用程序的外部属性的来源。bootstrap 里面的属性会优先加载，它们默认也不能被本地相同配置覆盖。</p>
<p>对比 application 配置文件，bootstrap 配置文件具有以下几个特性：</p>
<ul>
<li>boostrap 由父 ApplicationContext 加载，比 applicaton 优先加载</li>
<li>boostrap 里面的属性不能被覆盖</li>
</ul>
<p>application 配置文件主要用于 Spring Boot 项目的自动化配置。<br>bootstrap 配置文件有以下几个应用场景：</p>
<ul>
<li>使用 Spring Cloud Config或nacos 配置中心时，这时需要在 bootstrap 配置文件中添加连接到配置中心的配置属性来加载外部配置中心的配置信息；</li>
<li>一些固定的不能被覆盖的属性</li>
<li>一些加密/解密的场景</li>
</ul>

        <h5 id="配置文件加载位置与顺序">
          <a href="#配置文件加载位置与顺序" class="heading-link"><i class="fas fa-link"></i></a><a href="#配置文件加载位置与顺序" class="headerlink" title="配置文件加载位置与顺序"></a>配置文件加载位置与顺序</h5>
      <blockquote>
<ul>
<li>file:./config/</li>
<li>file:./</li>
<li>classpath:/config/</li>
<li>classpath:/</li>
</ul>
</blockquote>
<p>以上顺序按照优先级从高到低的顺序，所有位置的文件都会被加载，高优先级的配置内容会覆盖低优先级配置的内容，其中配置文件中的内容是互补配置，即</p>
<ul>
<li>存在相同的配置内容，高优先级的内容会覆盖低优先级的内容</li>
<li>存在不同的内容的时候，高优先级和低优先级的配置内容取并集</li>
</ul>

        <h3 id="加载配置文件数据">
          <a href="#加载配置文件数据" class="heading-link"><i class="fas fa-link"></i></a><a href="#加载配置文件数据" class="headerlink" title="加载配置文件数据"></a>加载配置文件数据</h3>
      <p>这个配置作用是spring在启动之间准备上下文时会启用这个配置来导入nacos相关配置文件，为后续容器启动做准备。对应的配置类<code>NacosConfigBootstrapConfiguration</code>如下：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(</span></span><br><span class="line"><span class="meta">    name = &#123;&quot;spring.cloud.nacos.config.enabled&quot;&#125;,</span></span><br><span class="line"><span class="meta">    matchIfMissing = true</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosConfigBootstrapConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NacosConfigBootstrapConfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NacosConfigProperties <span class="title">nacosConfigProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NacosConfigProperties();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NacosConfigManager <span class="title">nacosConfigManager</span><span class="params">(NacosConfigProperties nacosConfigProperties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NacosConfigManager(nacosConfigProperties);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NacosPropertySourceLocator <span class="title">nacosPropertySourceLocator</span><span class="params">(NacosConfigManager nacosConfigManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NacosPropertySourceLocator(nacosConfigManager);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<ul>
<li>NacosConfigProperties：对应我们上面在<code>bootstrap.yml</code>中对应的配置信息</li>
<li>NacosConfigManager: 持有<code>NacosConfigProperties</code>和<code>ConfigService</code>，<code>ConfigService</code>用来查询发布配置的相关接口</li>
<li>NacosPropertySourceLocator : 它实现了PropertySourceLocator，Spring Boot启动时调用<code>PropertySourceLocator.locate(env)</code>用来加载配置信息</li>
</ul>
<p>我们来看下PropertySourceLocator类相关代码：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Order(0)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosPropertySourceLocator</span> <span class="keyword">implements</span> <span class="title">PropertySourceLocator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(NacosPropertySourceLocator.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String NACOS_PROPERTY_SOURCE_NAME = <span class="string">&quot;NACOS&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SEP1 = <span class="string">&quot;-&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DOT = <span class="string">&quot;.&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> NacosPropertySourceBuilder nacosPropertySourceBuilder;</span><br><span class="line">    <span class="keyword">private</span> NacosConfigProperties nacosConfigProperties;</span><br><span class="line">    <span class="keyword">private</span> NacosConfigManager nacosConfigManager;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NacosPropertySourceLocator</span><span class="params">(NacosConfigManager nacosConfigManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.nacosConfigManager = nacosConfigManager;</span><br><span class="line">        <span class="keyword">this</span>.nacosConfigProperties = nacosConfigManager.getNacosConfigProperties();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> PropertySource&lt;?&gt; locate(Environment env) &#123;</span><br><span class="line">        <span class="keyword">this</span>.nacosConfigProperties.setEnvironment(env);</span><br><span class="line">        ConfigService configService = <span class="keyword">this</span>.nacosConfigManager.getConfigService();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == configService) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;no instance of config service found, can&#x27;t load config from nacos&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> timeout = (<span class="keyword">long</span>)<span class="keyword">this</span>.nacosConfigProperties.getTimeout();</span><br><span class="line">            <span class="keyword">this</span>.nacosPropertySourceBuilder = <span class="keyword">new</span> NacosPropertySourceBuilder(configService, timeout);</span><br><span class="line">            String name = <span class="keyword">this</span>.nacosConfigProperties.getName();</span><br><span class="line">            String dataIdPrefix = <span class="keyword">this</span>.nacosConfigProperties.getPrefix();</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(dataIdPrefix)) &#123;</span><br><span class="line">                dataIdPrefix = name;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(dataIdPrefix)) &#123;</span><br><span class="line">                dataIdPrefix = env.getProperty(<span class="string">&quot;spring.application.name&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            CompositePropertySource composite = <span class="keyword">new</span> CompositePropertySource(<span class="string">&quot;NACOS&quot;</span>);</span><br><span class="line">            <span class="comment">//加载共享的配置文件不同指定分组默认DEFAULT_GROUP，对应配置spring.cloud.nacos.config.sharedDataids=shared_1.properties,shared_2.properties</span></span><br><span class="line">            <span class="keyword">this</span>.loadSharedConfiguration(composite);</span><br><span class="line">            <span class="comment">//对应spring.cloud.nacos.config.ext-config[0].data-id=nacos.properties的配置</span></span><br><span class="line">            <span class="keyword">this</span>.loadExtConfiguration(composite);</span><br><span class="line">            <span class="comment">// 加载当前应用配置</span></span><br><span class="line">            <span class="keyword">this</span>.loadApplicationConfiguration(composite, dataIdPrefix, <span class="keyword">this</span>.nacosConfigProperties, env);</span><br><span class="line">            <span class="keyword">return</span> composite;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">private</span> NacosPropertySource <span class="title">loadNacosPropertySource</span><span class="params">(<span class="keyword">final</span> String dataId, <span class="keyword">final</span> String group, String fileExtension, <span class="keyword">boolean</span> isRefreshable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> NacosContextRefresher.getRefreshCount() != <span class="number">0L</span> &amp;&amp; !isRefreshable ? NacosPropertySourceRepository.getNacosPropertySource(dataId, group) : <span class="keyword">this</span>.nacosPropertySourceBuilder.build(dataId, group, fileExtension, isRefreshable);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>
<p>在真正加载配置文件<code>loadNacosPropertySource()</code>的时候，会调用到<code>nacosPropertySourceBuilder.build()</code>方法，我们在看下<code>build</code>干了什么。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosPropertySourceBuilder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(NacosPropertySourceBuilder.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Object&gt; EMPTY_MAP = <span class="keyword">new</span> LinkedHashMap();</span><br><span class="line">    <span class="keyword">private</span> ConfigService configService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> timeout;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NacosPropertySourceBuilder</span><span class="params">(ConfigService configService, <span class="keyword">long</span> timeout)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.configService = configService;</span><br><span class="line">        <span class="keyword">this</span>.timeout = timeout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTimeout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.timeout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTimeout</span><span class="params">(<span class="keyword">long</span> timeout)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.timeout = timeout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConfigService <span class="title">getConfigService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.configService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConfigService</span><span class="params">(ConfigService configService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.configService = configService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">NacosPropertySource <span class="title">build</span><span class="params">(String dataId, String group, String fileExtension, <span class="keyword">boolean</span> isRefreshable)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; p = <span class="keyword">this</span>.loadNacosData(dataId, group, fileExtension);</span><br><span class="line">        NacosPropertySource nacosPropertySource = <span class="keyword">new</span> NacosPropertySource(group, dataId, p, <span class="keyword">new</span> Date(), isRefreshable);</span><br><span class="line">        NacosPropertySourceRepository.collectNacosPropertySource(nacosPropertySource);</span><br><span class="line">        <span class="keyword">return</span> nacosPropertySource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title">loadNacosData</span><span class="params">(String dataId, String group, String fileExtension)</span> </span>&#123;</span><br><span class="line">        String data = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        	 <span class="comment">// 向nacos server拉取配置文件数据</span></span><br><span class="line">            data = <span class="keyword">this</span>.configService.getConfig(dataId, group, <span class="keyword">this</span>.timeout);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isEmpty(data)) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;Ignore the empty nacos configuration and get it based on dataId[&#123;&#125;] &amp; group[&#123;&#125;]&quot;</span>, dataId, group);</span><br><span class="line">                <span class="keyword">return</span> EMPTY_MAP;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(String.format(<span class="string">&quot;Loading nacos data, dataId: &#x27;%s&#x27;, group: &#x27;%s&#x27;, data: %s&quot;</span>, dataId, group, data));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Map&lt;String, Object&gt; dataMap = NacosDataParserHandler.getInstance().parseNacosData(data, fileExtension);</span><br><span class="line">            <span class="keyword">return</span> dataMap == <span class="keyword">null</span> ? EMPTY_MAP : dataMap;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NacosException var6) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;get data from Nacos error,dataId:&#123;&#125;, &quot;</span>, dataId, var6);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var7) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;parse data from Nacos error,dataId:&#123;&#125;,data:&#123;&#125;,&quot;</span>, <span class="keyword">new</span> Object[]&#123;dataId, data, var7&#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> EMPTY_MAP;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>可以看到<code>build</code>后面调用了<code>loadNacosData</code>，在<code>loadNacosData</code>中，先是<code>configService.getConfig</code>向配置中心拉去配置文件，然后在<code>parseNacosData()</code>解析配置文件。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosDataParserHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AbstractNacosDataParser parser;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">NacosDataParserHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.parser = <span class="keyword">this</span>.createParser();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">parseNacosData</span><span class="params">(String data, String extension)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == <span class="keyword">this</span>.parser) &#123;</span><br><span class="line">            <span class="keyword">this</span>.parser = <span class="keyword">this</span>.createParser();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.parser.parseNacosData(data, extension);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkDataId</span><span class="params">(String... dataIdAry)</span> </span>&#123;</span><br><span class="line">        StringBuilder stringBuilder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        String[] var3 = dataIdAry;</span><br><span class="line">        <span class="keyword">int</span> var4 = dataIdAry.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> var5 = <span class="number">0</span>; var5 &lt; var4; ++var5) &#123;</span><br><span class="line">            String dataId = var3[var5];</span><br><span class="line">            <span class="keyword">int</span> idx = dataId.lastIndexOf(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (idx &gt; <span class="number">0</span> &amp;&amp; idx &lt; dataId.length() - <span class="number">1</span>) &#123;</span><br><span class="line">                String extension = dataId.substring(idx + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.parser.checkFileExtension(extension)) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            stringBuilder.append(dataId).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (stringBuilder.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            String result = stringBuilder.substring(<span class="number">0</span>, stringBuilder.length() - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(AbstractNacosDataParser.getTips(result));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//支持properties、yaml、xml、json文件格式解析</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> AbstractNacosDataParser <span class="title">createParser</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> NacosDataPropertiesParser()).addNextParser(<span class="keyword">new</span> NacosDataYamlParser()).addNextParser(<span class="keyword">new</span> NacosDataXmlParser()).addNextParser(<span class="keyword">new</span> NacosDataJsonParser());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>


        <h3 id="nacos-config动态刷新机制">
          <a href="#nacos-config动态刷新机制" class="heading-link"><i class="fas fa-link"></i></a><a href="#nacos-config动态刷新机制" class="headerlink" title="nacos config动态刷新机制"></a>nacos config动态刷新机制</h3>
      
        <h4 id="动态刷新配置">
          <a href="#动态刷新配置" class="heading-link"><i class="fas fa-link"></i></a><a href="#动态刷新配置" class="headerlink" title="动态刷新配置"></a>动态刷新配置</h4>
      <p>当nacos上配置文件内容更新后，根据配置中的refresh属性来判断是否刷新配置，配置如下：</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.nacos.config.refresh.enabled=true</span><br></pre></td></tr></table></div></figure>
<p>该参数表示是否开启自动更新。增加了<code>spring.cloud.nacos.config.ext-config[0].refresh=true</code>配置后在修改了Nacos中的配置过后日志会出现下面信息，会重新加载配置，并且输出变更的key信息。<br>如果还需要对对应的 Bean内部的属性自动更新，加上这个配置后还需要在需要自动更新配置的Bean上面增加<code>@RefreshScope</code> 注解。<br><b>spring.cloud.nacos.config.refresh.enabled=true仅仅标识客户端会自动从远端拉取最新的配置</b>，具体的@Value以及@Refresh Bean的刷新和spring-cloud的机制有关系。</p>

        <h4 id="原理">
          <a href="#原理" class="heading-link"><i class="fas fa-link"></i></a><a href="#原理" class="headerlink" title="原理"></a>原理</h4>
      <p>大致的过程：<b>NacosConfigAutoConfiguration</b>配置类会注入一个<b>NacosContextRefresher</b>，它首先监听了ApplicationReadyEvent，然后注册一个nacos listener用来监听nacos config配置修改后发布一个<b>spring refreshEvent</b>用来刷新配置和应用。如果需要对<code>Bean</code>进行动态刷新，需要给类添加<code>@RefreshScope</code>或<code>@ConfigurationProperties</code>注解。</p>

        <h5 id="nacos-config注册监听器-registerNacosListener">
          <a href="#nacos-config注册监听器-registerNacosListener" class="heading-link"><i class="fas fa-link"></i></a><a href="#nacos-config注册监听器-registerNacosListener" class="headerlink" title="nacos config注册监听器-registerNacosListener"></a>nacos config注册监听器-registerNacosListener</h5>
      <p>NacosConfigAutoConfiguration.java</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosConfigAutoConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NacosConfigAutoConfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NacosContextRefresher <span class="title">nacosContextRefresher</span><span class="params">(NacosConfigManager nacosConfigManager, NacosRefreshHistory nacosRefreshHistory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NacosContextRefresher(nacosConfigManager, nacosRefreshHistory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>NacosContextRefresher.java</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosContextRefresher</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">ApplicationReadyEvent</span>&gt;, <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(NacosContextRefresher.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicLong REFRESH_COUNT = <span class="keyword">new</span> AtomicLong(<span class="number">0L</span>);</span><br><span class="line">    <span class="keyword">private</span> NacosConfigProperties nacosConfigProperties;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isRefreshEnabled;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NacosRefreshHistory nacosRefreshHistory;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConfigService configService;</span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line">    <span class="keyword">private</span> AtomicBoolean ready = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Listener&gt; listenerMap = <span class="keyword">new</span> ConcurrentHashMap(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NacosContextRefresher</span><span class="params">(NacosConfigManager nacosConfigManager, NacosRefreshHistory refreshHistory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.nacosConfigProperties = nacosConfigManager.getNacosConfigProperties();</span><br><span class="line">        <span class="keyword">this</span>.nacosRefreshHistory = refreshHistory;</span><br><span class="line">        <span class="keyword">this</span>.configService = nacosConfigManager.getConfigService();</span><br><span class="line">        <span class="keyword">this</span>.isRefreshEnabled = <span class="keyword">this</span>.nacosConfigProperties.isRefreshEnabled();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationReadyEvent event)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">// 只注册一次</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.ready.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.registerNacosListenersForApplications();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.applicationContext = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerNacosListenersForApplications</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.isRefreshEnabled()) &#123;</span><br><span class="line">            Iterator var1 = NacosPropertySourceRepository.getAll().iterator();</span><br><span class="line">            <span class="comment">//遍历每个配置文件</span></span><br><span class="line">            <span class="keyword">while</span>(var1.hasNext()) &#123;</span><br><span class="line">                NacosPropertySource propertySource = (NacosPropertySource)var1.next();</span><br><span class="line">                <span class="comment">//是否开启动态刷新，spring.cloud.nacos.config.refresh.enabled=true</span></span><br><span class="line">                <span class="keyword">if</span> (propertySource.isRefreshable()) &#123;</span><br><span class="line">                    String dataId = propertySource.getDataId();</span><br><span class="line">                    <span class="comment">// 注册nacos监听器</span></span><br><span class="line">                    <span class="keyword">this</span>.registerNacosListener(propertySource.getGroup(), dataId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerNacosListener</span><span class="params">(<span class="keyword">final</span> String group, <span class="keyword">final</span> String dataId)</span> </span>&#123;</span><br><span class="line">       	<span class="comment">//放进listenerMap中，如果不存在的话就创建一个AbstractSharedListener并返回</span></span><br><span class="line">        Listener listener = (Listener)<span class="keyword">this</span>.listenerMap.computeIfAbsent(dataId, (i) -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Listener() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveConfigInfo</span><span class="params">(String configInfo)</span> </span>&#123;</span><br><span class="line">                    NacosContextRefresher.refreshCountIncrement();</span><br><span class="line">                    String md5 = <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    <span class="keyword">if</span> (!StringUtils.isEmpty(configInfo)) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            MessageDigest md = MessageDigest.getInstance(<span class="string">&quot;MD5&quot;</span>);</span><br><span class="line">                            md5 = (<span class="keyword">new</span> BigInteger(<span class="number">1</span>, md.digest(configInfo.getBytes(<span class="string">&quot;UTF-8&quot;</span>)))).toString(<span class="number">16</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException | NoSuchAlgorithmException var4) &#123;</span><br><span class="line">                            NacosContextRefresher.log.warn(<span class="string">&quot;[Nacos] unable to get md5 for dataId: &quot;</span> + dataId, var4);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//添加刷新纪录	</span></span><br><span class="line">                    NacosContextRefresher.<span class="keyword">this</span>.refreshHistory.add(dataId, md5);</span><br><span class="line">                    <span class="comment">// 发布一个spring refreshEvent事件 对应监听器为RefreshEventListener 该监听器会完成配置的更新应用</span></span><br><span class="line">                    NacosContextRefresher.<span class="keyword">this</span>.applicationContext.publishEvent(<span class="keyword">new</span> RefreshEvent(<span class="keyword">this</span>, (Object)<span class="keyword">null</span>, <span class="string">&quot;Refresh Nacos config&quot;</span>));</span><br><span class="line">                    <span class="keyword">if</span> (NacosContextRefresher.log.isDebugEnabled()) &#123;</span><br><span class="line">                        NacosContextRefresher.log.debug(<span class="string">&quot;Refresh Nacos config group &quot;</span> + group + <span class="string">&quot;,dataId&quot;</span> + dataId);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Executor <span class="title">getExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        	<span class="comment">//把监听器到添加到配置服里务</span></span><br><span class="line">            <span class="keyword">this</span>.configService.addListener(dataId, group, listener);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NacosException var5) &#123;</span><br><span class="line">            var5.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NacosConfigProperties <span class="title">getNacosConfigProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.nacosConfigProperties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NacosContextRefresher <span class="title">setNacosConfigProperties</span><span class="params">(NacosConfigProperties nacosConfigProperties)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.nacosConfigProperties = nacosConfigProperties;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isRefreshEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == <span class="keyword">this</span>.nacosConfigProperties) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.isRefreshEnabled;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.nacosConfigProperties.isRefreshEnabled() &amp;&amp; !<span class="keyword">this</span>.isRefreshEnabled ? <span class="keyword">false</span> : <span class="keyword">this</span>.isRefreshEnabled;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getRefreshCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> REFRESH_COUNT.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">refreshCountIncrement</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        REFRESH_COUNT.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p><code>nacos config starter</code>默认为所有获取数据成功的nacos的配置项添加了<code>监听功能</code>，<code>nacos config</code>会监听<code>nacos server</code>上配置更新变化。在监听到服务端配置发生变化时会实时触发<code>org.springframework.cloud.context.refresh.ContextRefresher</code>的<code>refresh</code>方法。</p>

        <h5 id="nacos-config监听事件">
          <a href="#nacos-config监听事件" class="heading-link"><i class="fas fa-link"></i></a><a href="#nacos-config监听事件" class="headerlink" title="nacos config监听事件"></a>nacos config监听事件</h5>
      <p>一般客户端和服务端数据交互数据有以下两种：</p>
<ul>
<li>pull：客户端主动从服务器拉取数据</li>
<li>push: 由服务端主动向客户端推送数据<br>这两种模式优缺点各不一样，pull模式需要考虑的是什么时候向服务端拉取数据，可能会存在数据延迟问题，而push模式需要客户端和服务端维护一个长连接 如果客户端较多会给服务端造成压力但它的实时性会更好。</li>
</ul>
<p>nacos采用的是<b>pull</b>模式，但它作了优化可以看做是pull+push，客户端会轮询向服务端发出一个长连接请求，这个长连接最多30s就会超时。服务端收到客户端的请求会先判断当前是否有配置更新，有则立即返回。<br>如果没有，服务端会将这个请求加入延时任务，hold住29.5s，最后0.5s再检测配置文件无论有没有更新都进行正常返回，但等待的29.5s期间有配置更新可以提前结束并返回。</p>

        <h5 id="nacos-config客户端处理">
          <a href="#nacos-config客户端处理" class="heading-link"><i class="fas fa-link"></i></a><a href="#nacos-config客户端处理" class="headerlink" title="nacos config客户端处理"></a>nacos config客户端处理</h5>
      <p>动态监听的发起是在ConfigService的实现类NacosConfigService的构造方法中，它是对外nacos config api接口。NacosConfigService的实例化在NacosContextRefresher构造方法中都会获取或创建。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//NacosConfigAutoConfiguration.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosConfigAutoConfiguration</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> NacosContextRefresher <span class="title">nacosContextRefresher</span><span class="params">(NacosConfigProperties nacosConfigProperties, NacosRefreshProperties nacosRefreshProperties, NacosRefreshHistory refreshHistory)</span> </span>&#123;</span><br><span class="line">    	<span class="comment">//加载的configService为com.alibaba.nacos.client.config.NacosConfigService</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NacosContextRefresher(nacosRefreshProperties, refreshHistory, nacosConfigProperties.configServiceInstance());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//NacosContextRefresher.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosContextRefresher</span> <span class="keyword">implements</span> <span class="title">ApplicationListener</span>&lt;<span class="title">ApplicationReadyEvent</span>&gt;, <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = LoggerFactory.getLogger(NacosContextRefresher.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicLong REFRESH_COUNT = <span class="keyword">new</span> AtomicLong(<span class="number">0L</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NacosRefreshProperties refreshProperties;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> NacosRefreshHistory refreshHistory;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConfigService configService;</span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line">    <span class="keyword">private</span> AtomicBoolean ready = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Listener&gt; listenerMap = <span class="keyword">new</span> ConcurrentHashMap(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NacosContextRefresher</span><span class="params">(NacosRefreshProperties refreshProperties, NacosRefreshHistory refreshHistory, ConfigService configService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.refreshProperties = refreshProperties;</span><br><span class="line">        <span class="keyword">this</span>.refreshHistory = refreshHistory;</span><br><span class="line">        <span class="keyword">this</span>.configService = configService;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></div></figure>
<p>上面两个类在<code>spring-cloud-alibaba-nacos-config:0.9.0.RELEASE.jar</code>包</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosConfigService</span> <span class="keyword">implements</span> <span class="title">ConfigService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LogUtils.logger(NacosConfigService.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> POST_TIMEOUT = <span class="number">3000L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EMPTY = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> HttpAgent agent;</span><br><span class="line">    <span class="keyword">private</span> ClientWorker worker;</span><br><span class="line">    <span class="keyword">private</span> String namespace;</span><br><span class="line">    <span class="keyword">private</span> String encode;</span><br><span class="line">    <span class="keyword">private</span> ConfigFilterChainManager configFilterChainManager = <span class="keyword">new</span> ConfigFilterChainManager();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NacosConfigService</span><span class="params">(Properties properties)</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">        String encodeTmp = properties.getProperty(<span class="string">&quot;encode&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(encodeTmp)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.encode = <span class="string">&quot;UTF-8&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.encode = encodeTmp.trim();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.initNamespace(properties);</span><br><span class="line">         <span class="comment">// 用来向nacos server发起请求的代理，这里用到了装饰模式</span></span><br><span class="line">        <span class="keyword">this</span>.agent = <span class="keyword">new</span> MetricsHttpAgent(<span class="keyword">new</span> ServerHttpAgent(properties));</span><br><span class="line">        <span class="keyword">this</span>.agent.start();</span><br><span class="line">        <span class="comment">//客户端的一个工作类，agent作为它的构造传参 可猜想到里面肯定会做一些远程调用</span></span><br><span class="line">        <span class="keyword">this</span>.worker = <span class="keyword">new</span> ClientWorker(<span class="keyword">this</span>.agent, <span class="keyword">this</span>.configFilterChainManager);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  ｝  </span><br></pre></td></tr></table></div></figure>
<p>NacosConfigService、ClientWorker在<code>nacos-client:1.0.0.jar</code>包，</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ClientWorker</span><span class="params">(<span class="keyword">final</span> HttpAgent agent, ConfigFilterChainManager configFilterChainManager)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.agent = agent;</span><br><span class="line">        <span class="keyword">this</span>.configFilterChainManager = configFilterChainManager;</span><br><span class="line">         <span class="comment">// 这个线程池只有一个核心线程 用来执行checkConfigInfo()方法</span></span><br><span class="line">        <span class="keyword">this</span>.executor = Executors.newScheduledThreadPool(<span class="number">1</span>, <span class="keyword">new</span> ThreadFactory() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">                Thread t = <span class="keyword">new</span> Thread(r);</span><br><span class="line">                t.setName(<span class="string">&quot;com.alibaba.nacos.client.Worker.&quot;</span> + agent.getName());</span><br><span class="line">                t.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 其它需要执行线程的地方都交给这个线程池来处理</span></span><br><span class="line">        <span class="keyword">this</span>.executorService = Executors.newCachedThreadPool(<span class="keyword">new</span> ThreadFactory() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">                Thread t = <span class="keyword">new</span> Thread(r);</span><br><span class="line">                t.setName(<span class="string">&quot;com.alibaba.nacos.client.Worker.longPolling&quot;</span> + agent.getName());</span><br><span class="line">                t.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">return</span> t;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 执行一个调用checkConfigInfo()方法的周期性任务，每10ms执行一次，首次执行延迟1ms后执行</span></span><br><span class="line">        <span class="keyword">this</span>.executor.scheduleWithFixedDelay(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ClientWorker.<span class="keyword">this</span>.checkConfigInfo();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var2) &#123;</span><br><span class="line">                    ClientWorker.LOGGER.error(<span class="string">&quot;[&quot;</span> + agent.getName() + <span class="string">&quot;] [sub-check] rotate check error&quot;</span>, var2);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1L</span>, <span class="number">10L</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkConfigInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   		<span class="comment">//分任务</span></span><br><span class="line">        <span class="keyword">int</span> listenerSize = ((Map)<span class="keyword">this</span>.cacheMap.get()).size();</span><br><span class="line">        <span class="keyword">int</span> longingTaskCount = (<span class="keyword">int</span>)Math.ceil((<span class="keyword">double</span>)listenerSize / ParamUtil.getPerTaskConfigSize());</span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">double</span>)longingTaskCount &gt; <span class="keyword">this</span>.currentLongingTaskCount) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = (<span class="keyword">int</span>)<span class="keyword">this</span>.currentLongingTaskCount; i &lt; longingTaskCount; ++i) &#123;</span><br><span class="line">                <span class="keyword">this</span>.executorService.execute(<span class="keyword">new</span> ClientWorker.LongPollingRunnable(i));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.currentLongingTaskCount = (<span class="keyword">double</span>)longingTaskCount;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>
<p>可以看到 ClientWorker 除了将 HttpAgent 维持在自己内部，还创建了两个线程池：</p>
<ul>
<li>第一个线程池是只拥有一个线程用来执行定时任务的 executor，executor 每隔 10ms 就会执行一次 checkConfigInfo() 方法，从方法名上可以知道是每 10 ms 检查一次配置信息。</li>
<li>第二个线程池是一个普通的线程池，从 ThreadFactory 的名称可以看到这个线程池是做长轮询的。</li>
</ul>
<p>checkConfigInfo方法是取出了一批任务，然后提交给 executorService 线程池去执行，执行的任务就是 LongPollingRunnable，每个任务都有一个 taskId。</p>

        <h6 id="LongPollingRunnable">
          <a href="#LongPollingRunnable" class="heading-link"><i class="fas fa-link"></i></a><a href="#LongPollingRunnable" class="headerlink" title="LongPollingRunnable"></a>LongPollingRunnable</h6>
      <p>LongPollingRunnable的逻辑主要分为三部分，第一部分是检查本地的配置信息，第二部分是获取服务端的配置信息然后更新到本地，第三部分触发监听器receiveConfigInfo方法，发布RefreshEvent事件</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LongPollingRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">int</span> taskId;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">LongPollingRunnable</span><span class="params">(<span class="keyword">int</span> taskId)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">this</span>.taskId = taskId;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              List&lt;CacheData&gt; cacheDatas = <span class="keyword">new</span> ArrayList();</span><br><span class="line"></span><br><span class="line">              <span class="comment">/**本地检查**/</span></span><br><span class="line">              Iterator var2 = ((Map)ClientWorker.<span class="keyword">this</span>.cacheMap.get()).values().iterator();</span><br><span class="line"></span><br><span class="line">              <span class="keyword">while</span>(var2.hasNext()) &#123;</span><br><span class="line">                  CacheData cacheDatax = (CacheData)var2.next();</span><br><span class="line">                  <span class="keyword">if</span> (cacheDatax.getTaskId() == <span class="keyword">this</span>.taskId) &#123;</span><br><span class="line">                      cacheDatas.add(cacheDatax);</span><br><span class="line"></span><br><span class="line">                      <span class="keyword">try</span> &#123;</span><br><span class="line">                          ClientWorker.<span class="keyword">this</span>.checkLocalConfig(cacheDatax);</span><br><span class="line">                          <span class="keyword">if</span> (cacheDatax.isUseLocalConfigInfo()) &#123;</span><br><span class="line">                              cacheDatax.checkListenerMd5();</span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125; <span class="keyword">catch</span> (Exception var18) &#123;</span><br><span class="line">                          ClientWorker.LOGGER.error(<span class="string">&quot;get local config info error&quot;</span>, var18);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">/**本地检查**/</span></span><br><span class="line">              <span class="comment">/**获取服务端最新配置**/</span></span><br><span class="line">              List&lt;String&gt; inInitializingCacheList = <span class="keyword">new</span> ArrayList();</span><br><span class="line">              <span class="comment">//向nacos server发出一个长连接 30s超时，返回nacos server有更新过的dataIds，调用server端的/v1/cs/configs/listener</span></span><br><span class="line">              List&lt;String&gt; changedGroupKeys = ClientWorker.<span class="keyword">this</span>.checkUpdateDataIds(cacheDatas, inInitializingCacheList);</span><br><span class="line">              Iterator var4 = changedGroupKeys.iterator();</span><br><span class="line"></span><br><span class="line">              <span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">                  String groupKey = (String)var4.next();</span><br><span class="line">                  String[] key = GroupKey.parseKey(groupKey);</span><br><span class="line">                  String dataId = key[<span class="number">0</span>];</span><br><span class="line">                  String group = key[<span class="number">1</span>];</span><br><span class="line">                  String tenant = <span class="keyword">null</span>;</span><br><span class="line">                  <span class="keyword">if</span> (key.length == <span class="number">3</span>) &#123;</span><br><span class="line">                      tenant = key[<span class="number">2</span>];</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      String content = ClientWorker.<span class="keyword">this</span>.getServerConfig(dataId, group, tenant, <span class="number">3000L</span>);</span><br><span class="line">                      CacheData cache = (CacheData)((Map)ClientWorker.<span class="keyword">this</span>.cacheMap.get()).get(GroupKey.getKeyTenant(dataId, group, tenant));</span><br><span class="line">                      cache.setContent(content);</span><br><span class="line">                      ClientWorker.LOGGER.info(<span class="string">&quot;[&#123;&#125;] [data-received] dataId=&#123;&#125;, group=&#123;&#125;, tenant=&#123;&#125;, md5=&#123;&#125;, content=&#123;&#125;&quot;</span>, <span class="keyword">new</span> Object[]&#123;ClientWorker.<span class="keyword">this</span>.agent.getName(), dataId, group, tenant, cache.getMd5(), ContentUtils.truncateContent(content)&#125;);</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (NacosException var17) &#123;</span><br><span class="line">                      String message = String.format(<span class="string">&quot;[%s] [get-update] get changed config exception. dataId=%s, group=%s, tenant=%s&quot;</span>, ClientWorker.<span class="keyword">this</span>.agent.getName(), dataId, group, tenant);</span><br><span class="line">                      ClientWorker.LOGGER.error(message, var17);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">/**获取服务端最新配置**/</span></span><br><span class="line"></span><br><span class="line">  			<span class="comment">/**触发监听器receiveConfigInfo方法，发布RefreshEvent事件**/</span></span><br><span class="line">              var4 = cacheDatas.iterator();</span><br><span class="line"></span><br><span class="line">              <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                  CacheData cacheData;</span><br><span class="line">                  <span class="keyword">do</span> &#123;</span><br><span class="line">                      <span class="keyword">if</span> (!var4.hasNext()) &#123;</span><br><span class="line">                          inInitializingCacheList.clear();</span><br><span class="line">                          <span class="keyword">return</span>;</span><br><span class="line">                      &#125;</span><br><span class="line"></span><br><span class="line">                      cacheData = (CacheData)var4.next();</span><br><span class="line">                  &#125; <span class="keyword">while</span>(cacheData.isInitializing() &amp;&amp; !inInitializingCacheList.contains(GroupKey.getKeyTenant(cacheData.dataId, cacheData.group, cacheData.tenant)));</span><br><span class="line"></span><br><span class="line">                  cacheData.checkListenerMd5();</span><br><span class="line">                  cacheData.setInitializing(<span class="keyword">false</span>);</span><br><span class="line">              &#125;</span><br><span class="line">  			<span class="comment">/**触发监听器receiveConfigInfo方法，发布RefreshEvent事件**/</span></span><br><span class="line">          &#125; <span class="keyword">catch</span> (Throwable var19) &#123;</span><br><span class="line">              ClientWorker.LOGGER.error(<span class="string">&quot;longPolling error&quot;</span>, var19);</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">              ClientWorker.<span class="keyword">this</span>.executorService.execute(<span class="keyword">this</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></div></figure>
<ul>
<li>检查本地的配置信息</li>
</ul>
<p>首先取出与该 taskId 相关的 CacheData，然后对 CacheData 进行检查，包括本地配置检查和监听器的 md5 检查，本地检查主要是做一个故障容错，当服务端挂掉后，Nacos 客户端可以从本地的文件系统中获取相关的配置信息。<br>通过跟踪 checkLocalConfig 方法，可以看到 Nacos 将配置信息保存在了<code>$&#123;user.home&#125;/nacos/config/$&#123;serverName&#125;_nacos/data/config-data-tenant/$&#123;tenant&#125;/$&#123;group&#125;/$&#123;dataId&#125;</code>，其中serverName的组成格式为<code>fixed-$&#123;IP&#125;_$&#123;Port&#125;-$&#123;namespaceId&#125;_nacos</code>。其中，tenant为nameSpaceId，group<br>为DEFAULT_GROUP。</p>
<ul>
<li><p>服务端检查<br>通过checkUpdateDataIds()方法从服务端获取那些值发生了变化的dataId列表。通过getServerConfig方法，根据dataId到服务端获取最新的配置信息，接着将最新的配置信息保存到CacheData中。最后调用CacheData的checkListenerMd5方法。</p>
</li>
<li><p>触发回调</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">checkListenerMd5</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Iterator var1 = <span class="keyword">this</span>.listeners.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var1.hasNext()) &#123;</span><br><span class="line">            ManagerListenerWrap wrap = (ManagerListenerWrap)var1.next();</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.md5.equals(wrap.lastCallMd5)) &#123;</span><br><span class="line">                <span class="keyword">this</span>.safeNotifyListener(<span class="keyword">this</span>.dataId, <span class="keyword">this</span>.group, <span class="keyword">this</span>.content, <span class="keyword">this</span>.md5, wrap);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">safeNotifyListener</span><span class="params">(<span class="keyword">final</span> String dataId, <span class="keyword">final</span> String group, <span class="keyword">final</span> String content, <span class="keyword">final</span> String md5, <span class="keyword">final</span> ManagerListenerWrap listenerWrap)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Listener listener = listenerWrap.listener;</span><br><span class="line">        Runnable job = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                ClassLoader myClassLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">                ClassLoader appClassLoader = listener.getClass().getClassLoader();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    ...</span><br><span class="line"></span><br><span class="line">                    Thread.currentThread().setContextClassLoader(appClassLoader);</span><br><span class="line">                    ConfigResponse cr = <span class="keyword">new</span> ConfigResponse();</span><br><span class="line">                    cr.setDataId(dataId);</span><br><span class="line">                    cr.setGroup(group);</span><br><span class="line">                    cr.setContent(content);</span><br><span class="line">                    CacheData.<span class="keyword">this</span>.configFilterChainManager.doFilter((IConfigRequest)<span class="keyword">null</span>, cr);</span><br><span class="line">                    String contentTmp = cr.getContent();</span><br><span class="line">                    listener.receiveConfigInfo(contentTmp);</span><br><span class="line">                    <span class="comment">//更新 ListenerWrap 的 md5 值</span></span><br><span class="line">                    listenerWrap.lastCallMd5 = md5;</span><br><span class="line">                    CacheData.LOGGER.info(<span class="string">&quot;[&#123;&#125;] [notify-ok] dataId=&#123;&#125;, group=&#123;&#125;, md5=&#123;&#125;, listener=&#123;&#125; &quot;</span>, <span class="keyword">new</span> Object[]&#123;CacheData.<span class="keyword">this</span>.name, dataId, group, md5, listener&#125;);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NacosException var9) &#123;</span><br><span class="line">                    CacheData.LOGGER.error(<span class="string">&quot;[&#123;&#125;] [notify-error] dataId=&#123;&#125;, group=&#123;&#125;, md5=&#123;&#125;, listener=&#123;&#125; errCode=&#123;&#125; errMsg=&#123;&#125;&quot;</span>, <span class="keyword">new</span> Object[]&#123;CacheData.<span class="keyword">this</span>.name, dataId, group, md5, listener, var9.getErrCode(), var9.getErrMsg()&#125;);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var10) &#123;</span><br><span class="line">                    CacheData.LOGGER.error(<span class="string">&quot;[&#123;&#125;] [notify-error] dataId=&#123;&#125;, group=&#123;&#125;, md5=&#123;&#125;, listener=&#123;&#125; tx=&#123;&#125;&quot;</span>, <span class="keyword">new</span> Object[]&#123;CacheData.<span class="keyword">this</span>.name, dataId, group, md5, listener, var10.getCause()&#125;);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    Thread.currentThread().setContextClassLoader(myClassLoader);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure>
<p>该方法会检查 CacheData 当前的 md5 与 CacheData 持有的所有 Listener 中保存的md5的值是否一致，如果不一致，就执行一个安全的监听器的通知方法：safeNotifyListener，通知 Listener 的使用者，该 Listener 所关注的配置信息已经发生改变了。</p>
</li>
</ul>

        <h6 id="CacheData中MD5值何时更新">
          <a href="#CacheData中MD5值何时更新" class="heading-link"><i class="fas fa-link"></i></a><a href="#CacheData中MD5值何时更新" class="headerlink" title="CacheData中MD5值何时更新"></a>CacheData中MD5值何时更新</h6>
      <p>LongPollingRunnable 所执行的任务中，在获取服务端发生变更的配置信息时，将最新的 content 数据写入了 CacheData 中，我们可以看下该方法如下：</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContent</span><span class="params">(String newContent)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.content = newContent;</span><br><span class="line">       <span class="keyword">this</span>.md5 = getMd5String(<span class="keyword">this</span>.content);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>

<p>在长轮询的任务中，当服务端配置信息发生变更时，客户端将最新的数据获取下来之后，保存在了 CacheData 中，同时更新了该 CacheData 的md5值，所以当下次执行checkListenerMd5 方法时，就会发现当前 listener 所持有的 md5 值已经和CacheData的md5值不一样了，也就意味着服务端的配置信息发生改变了，这时就需要将最新的数据通知给 Listener 的持有者。</p>

        <h5 id="nacos-server处理">
          <a href="#nacos-server处理" class="heading-link"><i class="fas fa-link"></i></a><a href="#nacos-server处理" class="headerlink" title="nacos server处理"></a>nacos server处理</h5>
      
        <h6 id="ClientLongPolling延时任务">
          <a href="#ClientLongPolling延时任务" class="heading-link"><i class="fas fa-link"></i></a><a href="#ClientLongPolling延时任务" class="headerlink" title="ClientLongPolling延时任务"></a>ClientLongPolling延时任务</h6>
      <p>从上文LongPollingRunnable长轮询任务，可以知道远程调用的接口URL为<code>/v1/cs/configs/listener</code>。对应的类为<code>ConfigController</code></p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The client listens for configuration changes.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/listener&quot;)</span></span><br><span class="line"><span class="meta">@Secured(action = ActionTypes.READ, parser = ConfigResourceParser.class)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listener</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    </span><br><span class="line">    request.setAttribute(<span class="string">&quot;org.apache.catalina.ASYNC_SUPPORTED&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">    String probeModify = request.getParameter(<span class="string">&quot;Listening-Configs&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isBlank(probeModify)) &#123;</span><br><span class="line">        LOGGER.warn(<span class="string">&quot;invalid probeModify is blank&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;invalid probeModify&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    probeModify = URLDecoder.decode(probeModify, Constants.ENCODE);</span><br><span class="line">    </span><br><span class="line">    Map&lt;String, String&gt; clientMd5Map;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        clientMd5Map = MD5Util.getClientMd5Map(probeModify);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;invalid probeModify&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// do long-polling</span></span><br><span class="line">    inner.doPollingConfig(request, response, clientMd5Map, probeModify.length());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>
<p>我们看下doPollingConfig方法，这里的inner 对象是 ConfigServletInner 类的实例，具体的方法如下所示：<br> <figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">doPollingConfig</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="params"><span class="function">            Map&lt;String, String&gt; clientMd5Map, <span class="keyword">int</span> probeRequestSize)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Long polling.</span></span><br><span class="line">        <span class="keyword">if</span> (LongPollingService.isSupportLongPolling(request)) &#123;</span><br><span class="line">            longPollingService.addLongPollingClient(request, response, clientMd5Map, probeRequestSize);</span><br><span class="line">            <span class="keyword">return</span> HttpServletResponse.SC_OK + <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></div></figure><br>再次进入 longPollingService 的 addLongPollingClient 方法</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLongPollingClient</span><span class="params">(HttpServletRequest req, HttpServletResponse rsp, Map&lt;String, String&gt; clientMd5Map,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">int</span> probeRequestSize)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">    String str = req.getHeader(LongPollingService.LONG_POLLING_HEADER);</span><br><span class="line">    String noHangUpFlag = req.getHeader(LongPollingService.LONG_POLLING_NO_HANG_UP_HEADER);</span><br><span class="line">    String appName = req.getHeader(RequestUtil.CLIENT_APPNAME_HEADER);</span><br><span class="line">    String tag = req.getHeader(<span class="string">&quot;Vipserver-Tag&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 服务端这边最多处理时长29.5s，需要留0.5s来返回，以免客户端那边超时</span></span><br><span class="line">    <span class="keyword">int</span> delayTime = SwitchService.getSwitchInteger(SwitchService.FIXED_DELAY_TIME, <span class="number">500</span>);</span><br><span class="line">    <span class="comment">// Add delay time for LoadBalance, and one response is returned 500 ms in advance to avoid client timeout.</span></span><br><span class="line">    <span class="keyword">long</span> timeout = Math.max(<span class="number">10000</span>, Long.parseLong(str) - delayTime);</span><br><span class="line">    <span class="keyword">if</span> (isFixedPolling()) &#123;</span><br><span class="line">        timeout = Math.max(<span class="number">10000</span>, getFixedPollingInterval());</span><br><span class="line">        <span class="comment">// Do nothing but set fix polling timeout.</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 不支持长轮询 本地对比返回</span></span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        List&lt;String&gt; changedGroups = MD5Util.compareMd5(req, rsp, clientMd5Map);</span><br><span class="line">        <span class="keyword">if</span> (changedGroups.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            generateResponse(req, rsp, changedGroups);</span><br><span class="line">            <span class="comment">// log....</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (noHangUpFlag != <span class="keyword">null</span> &amp;&amp; noHangUpFlag.equalsIgnoreCase(TRUE_STR)) &#123;</span><br><span class="line">            <span class="comment">// log....</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    String ip = RequestUtil.getRemoteIp(req);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将http响应交给异步线程，返回一个异步响应上下文, 当配置更新后可以主动调用及时返回，不用非等待29.5s</span></span><br><span class="line">    <span class="keyword">final</span> AsyncContext asyncContext = req.startAsync();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// AsyncContext.setTimeout() is incorrect, Control by oneself</span></span><br><span class="line">    asyncContext.setTimeout(<span class="number">0L</span>);</span><br><span class="line">    <span class="comment">// 执行客户端长连接任务，</span></span><br><span class="line">    ConfigExecutor.executeLongPolling(</span><br><span class="line">            <span class="keyword">new</span> ClientLongPolling(asyncContext, clientMd5Map, ip, probeRequestSize, timeout, appName, tag));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>服务端将客户端的长轮询请求封装成一个叫 ClientLongPolling 的任务，交给 scheduler 去执行。服务端拿到客户端提交的超时时间后，又减去了 500ms 也就是说服务端在这里使用了一个比客户端提交的时间少 500ms 的超时时间，也就是 29.5s。<br>接下来我们来看服务端封装的 ClientLongPolling 的任务</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClientLongPolling</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">      </span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      	<span class="comment">// 提交一个任务，延迟29.5s执行</span></span><br><span class="line">          asyncTimeoutFuture = ConfigExecutor.scheduleLongPolling(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">              <span class="meta">@Override</span></span><br><span class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      getRetainIps().put(ClientLongPolling.<span class="keyword">this</span>.ip, System.currentTimeMillis());</span><br><span class="line">                      </span><br><span class="line">                      <span class="comment">// Delete subscriber&#x27;s relations.</span></span><br><span class="line">                      <span class="keyword">boolean</span> removeFlag = allSubs.remove(ClientLongPolling.<span class="keyword">this</span>);</span><br><span class="line">                      </span><br><span class="line">                      <span class="keyword">if</span> (removeFlag) &#123;</span><br><span class="line">                          <span class="keyword">if</span> (isFixedPolling()) &#123;</span><br><span class="line">                              LogUtil.CLIENT_LOG</span><br><span class="line">                                      .info(<span class="string">&quot;&#123;&#125;|&#123;&#125;|&#123;&#125;|&#123;&#125;|&#123;&#125;|&#123;&#125;&quot;</span>, (System.currentTimeMillis() - createTime), <span class="string">&quot;fix&quot;</span>,</span><br><span class="line">                                              RequestUtil.getRemoteIp((HttpServletRequest) asyncContext.getRequest()),</span><br><span class="line">                                              <span class="string">&quot;polling&quot;</span>, clientMd5Map.size(), probeRequestSize);</span><br><span class="line">                              List&lt;String&gt; changedGroups = MD5Util</span><br><span class="line">                                      .compareMd5((HttpServletRequest) asyncContext.getRequest(),</span><br><span class="line">                                              (HttpServletResponse) asyncContext.getResponse(), clientMd5Map);</span><br><span class="line">                              <span class="keyword">if</span> (changedGroups.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                  sendResponse(changedGroups);</span><br><span class="line">                              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                  sendResponse(<span class="keyword">null</span>);</span><br><span class="line">                              &#125;</span><br><span class="line">                          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                              LogUtil.CLIENT_LOG</span><br><span class="line">                                      .info(<span class="string">&quot;&#123;&#125;|&#123;&#125;|&#123;&#125;|&#123;&#125;|&#123;&#125;|&#123;&#125;&quot;</span>, (System.currentTimeMillis() - createTime), <span class="string">&quot;timeout&quot;</span>,</span><br><span class="line">                                              RequestUtil.getRemoteIp((HttpServletRequest) asyncContext.getRequest()),</span><br><span class="line">                                              <span class="string">&quot;polling&quot;</span>, clientMd5Map.size(), probeRequestSize);</span><br><span class="line">                              sendResponse(<span class="keyword">null</span>);</span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                          LogUtil.DEFAULT_LOG.warn(<span class="string">&quot;client subsciber&#x27;s relations delete fail.&quot;</span>);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                      LogUtil.DEFAULT_LOG.error(<span class="string">&quot;long polling error:&quot;</span> + t.getMessage(), t.getCause());</span><br><span class="line">                  &#125;</span><br><span class="line">                  </span><br><span class="line">              &#125;</span><br><span class="line">              </span><br><span class="line">          &#125;, timeoutTime, TimeUnit.MILLISECONDS);</span><br><span class="line">          </span><br><span class="line">          allSubs.add(<span class="keyword">this</span>);</span><br><span class="line">      &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></div></figure>
<p>ClientLongPolling 被提交给 scheduler 执行之后，实际执行的内容可以拆分成以下四个步骤：</p>
<ul>
<li>创建一个调度的任务，调度的延时时间为 29.5s</li>
<li>将该 ClientLongPolling 自身的实例添加到一个 allSubs 中去</li>
<li>延时时间到了之后，首先将该 ClientLongPolling 自身的实例从 allSubs 中移除</li>
<li>对客户端提交上来的 groupKey 进行检查，如果发现某一个 groupKey 的 md5 值还不是最新的，则说明客户端的配置项还没发生变更，所以将该 groupKey 放到一个 changedGroupKeys 列表中，最后将该 changedGroupKeys 返回给客户端</li>
</ul>
<p>整个过程可以用下面的图进行描述：<br>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="clientLongPoll.png">
      </p>

        <h6 id="服务端数据变更">
          <a href="#服务端数据变更" class="heading-link"><i class="fas fa-link"></i></a><a href="#服务端数据变更" class="headerlink" title="服务端数据变更"></a>服务端数据变更</h6>
      <p>当我们在nacos server界面上修改配置文件内容后，对应调用的请求url为：/v1/cs/configs 并且是一个 POST 请求，具体的方法是 ConfigController 中的 publishConfig 方法</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Adds or updates non-aggregated data.</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> NacosException NacosException.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="meta">@PostMapping</span></span><br><span class="line"> <span class="meta">@Secured(action = ActionTypes.WRITE, parser = ConfigResourceParser.class)</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Boolean <span class="title">publishConfig</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="meta">@RequestParam(value = &quot;dataId&quot;)</span> String dataId, <span class="meta">@RequestParam(value = &quot;group&quot;)</span> String group,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="meta">@RequestParam(value = &quot;tenant&quot;, required = false, defaultValue = StringUtils.EMPTY)</span> String tenant,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="meta">@RequestParam(value = &quot;content&quot;)</span> String content, <span class="meta">@RequestParam(value = &quot;tag&quot;, required = false)</span> String tag,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="meta">@RequestParam(value = &quot;appName&quot;, required = false)</span> String appName,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="meta">@RequestParam(value = &quot;src_user&quot;, required = false)</span> String srcUser,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="meta">@RequestParam(value = &quot;config_tags&quot;, required = false)</span> String configTags,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="meta">@RequestParam(value = &quot;desc&quot;, required = false)</span> String desc,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="meta">@RequestParam(value = &quot;use&quot;, required = false)</span> String use,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="meta">@RequestParam(value = &quot;effect&quot;, required = false)</span> String effect,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="meta">@RequestParam(value = &quot;type&quot;, required = false)</span> String type,</span></span></span><br><span class="line"><span class="params"><span class="function">         <span class="meta">@RequestParam(value = &quot;schema&quot;, required = false)</span> String schema)</span> <span class="keyword">throws</span> NacosException </span>&#123;</span><br><span class="line">     </span><br><span class="line">     ... </span><br><span class="line">     ConfigInfo configInfo = <span class="keyword">new</span> ConfigInfo(dataId, group, tenant, appName, content);</span><br><span class="line">     configInfo.setType(type);</span><br><span class="line">     <span class="keyword">if</span> (StringUtils.isBlank(betaIps)) &#123;</span><br><span class="line">         <span class="keyword">if</span> (StringUtils.isBlank(tag)) &#123;</span><br><span class="line">             persistService.insertOrUpdate(srcIp, srcUser, configInfo, time, configAdvanceInfo, <span class="keyword">false</span>);</span><br><span class="line">             ConfigChangePublisher</span><br><span class="line">                     .notifyConfigChange(<span class="keyword">new</span> ConfigDataChangeEvent(<span class="keyword">false</span>, dataId, group, tenant, time.getTime()));</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             persistService.insertOrUpdateTag(configInfo, tag, srcIp, srcUser, time, <span class="keyword">false</span>);</span><br><span class="line">             ConfigChangePublisher.notifyConfigChange(</span><br><span class="line">                     <span class="keyword">new</span> ConfigDataChangeEvent(<span class="keyword">false</span>, dataId, group, tenant, tag, time.getTime()));</span><br><span class="line">         &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// beta publish</span></span><br><span class="line">         persistService.insertOrUpdateBeta(configInfo, betaIps, srcIp, srcUser, time, <span class="keyword">false</span>);</span><br><span class="line">         ConfigChangePublisher</span><br><span class="line">                 .notifyConfigChange(<span class="keyword">new</span> ConfigDataChangeEvent(<span class="keyword">true</span>, dataId, group, tenant, time.getTime()));</span><br><span class="line">     &#125;</span><br><span class="line">     ConfigTraceService</span><br><span class="line">             .logPersistenceEvent(dataId, group, tenant, requestIpApp, time.getTime(), InetUtils.getSelfIP(),</span><br><span class="line">                     ConfigTraceService.PERSISTENCE_EVENT_PUB, content);</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></div></figure>
<p>可以看到修改配置后，服务端首先将配置的值进行了持久化层的更新，然后触发了一个 ConfigDataChangeEvent 的事件。<br>进入到<code>notifyConfigChange(ConfigDataChangeEvent event)</code>方法，可以看到最后是调用了<code>NotifyCenter.publishEvent()</code>方法。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigChangePublisher</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Notify ConfigChange.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event ConfigDataChangeEvent instance.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">notifyConfigChange</span><span class="params">(ConfigDataChangeEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (PropertyUtil.isEmbeddedStorage() &amp;&amp; !EnvUtil.getStandaloneMode()) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        NotifyCenter.publishEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>最后调用的是<code>DefaultPublisher#publish()</code>方法。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultPublisher</span> <span class="keyword">extends</span> <span class="title">Thread</span> <span class="keyword">implements</span> <span class="title">EventPublisher</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">   </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">publish</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">        checkIsStart();</span><br><span class="line">        <span class="keyword">boolean</span> success = <span class="keyword">this</span>.queue.offer(event);</span><br><span class="line">        <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">            LOGGER.warn(<span class="string">&quot;Unable to plug in due to interruption, synchronize sending time, event : &#123;&#125;&quot;</span>, event);</span><br><span class="line">            receiveEvent(event);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Receive and notifySubscriber to process the event.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> event &#123;<span class="doctag">@link</span> Event&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">receiveEvent</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> currentEventSequence = event.sequence();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!hasSubscriber()) &#123;</span><br><span class="line">            LOGGER.warn(<span class="string">&quot;[NotifyCenter] the &#123;&#125; is lost, because there is no subscriber.&quot;</span>, event);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Notification single event listener</span></span><br><span class="line">        <span class="keyword">for</span> (Subscriber subscriber : subscribers) &#123;</span><br><span class="line">            <span class="comment">// Whether to ignore expiration events</span></span><br><span class="line">            <span class="keyword">if</span> (subscriber.ignoreExpireEvent() &amp;&amp; lastEventSequence &gt; currentEventSequence) &#123;</span><br><span class="line">                LOGGER.debug(<span class="string">&quot;[NotifyCenter] the &#123;&#125; is unacceptable to this subscriber, because had expire&quot;</span>,</span><br><span class="line">                        event.getClass());</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Because unifying smartSubscriber and subscriber, so here need to think of compatibility.</span></span><br><span class="line">            <span class="comment">// Remove original judge part of codes.</span></span><br><span class="line">            notifySubscriber(subscriber, event);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifySubscriber</span><span class="params">(<span class="keyword">final</span> Subscriber subscriber, <span class="keyword">final</span> Event event)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        LOGGER.debug(<span class="string">&quot;[NotifyCenter] the &#123;&#125; will received by &#123;&#125;&quot;</span>, event, subscriber);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">final</span> Runnable job = () -&gt; subscriber.onEvent(event);</span><br><span class="line">        <span class="keyword">final</span> Executor executor = subscriber.executor();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (executor != <span class="keyword">null</span>) &#123;</span><br><span class="line">            executor.execute(job);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                job.run();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                LOGGER.error(<span class="string">&quot;Event callback exception: &quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>最后<code>subscriber.onEvent(event);</code>对应的Subscriber就在LongPollingService类中</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LongPollingService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       allSubs = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;ClientLongPolling&gt;();</span><br><span class="line">       </span><br><span class="line">       ConfigExecutor.scheduleLongPolling(<span class="keyword">new</span> StatTask(), <span class="number">0L</span>, <span class="number">10L</span>, TimeUnit.SECONDS);</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// Register LocalDataChangeEvent to NotifyCenter.</span></span><br><span class="line">       NotifyCenter.registerToPublisher(LocalDataChangeEvent.class, NotifyCenter.ringBufferSize);</span><br><span class="line">       </span><br><span class="line">       <span class="comment">// Register A Subscriber to subscribe LocalDataChangeEvent.</span></span><br><span class="line">       NotifyCenter.registerSubscriber(<span class="keyword">new</span> Subscriber() &#123;</span><br><span class="line">           </span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">               <span class="keyword">if</span> (isFixedPolling()) &#123;</span><br><span class="line">                   <span class="comment">// Ignore.</span></span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="keyword">if</span> (event <span class="keyword">instanceof</span> LocalDataChangeEvent) &#123;</span><br><span class="line">                       LocalDataChangeEvent evt = (LocalDataChangeEvent) event;</span><br><span class="line">                       ConfigExecutor.executeLongPolling(<span class="keyword">new</span> DataChangeTask(evt.groupKey, evt.isBeta, evt.betaIps));</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> Class&lt;? extends Event&gt; subscribeType() &#123;</span><br><span class="line">               <span class="keyword">return</span> LocalDataChangeEvent.class;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">       </span><br><span class="line">   &#125;</span><br></pre></td></tr></table></div></figure>
<p>所以到这里我们就知道了，当我们从 dashboard 中更新了配置项之后，实际会调用到 LongPollingService 的 onEvent 方法。<br>当触发了 LongPollingService 的 onEvent 方法时，实际是执行了一个叫 DataChangeTask 的任务，应该是通过该任务来通知客户端服务端的数据已经发生了变更。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DataChangeTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ConfigCacheService.getContentBetaMd5(groupKey);</span><br><span class="line">                <span class="keyword">for</span> (Iterator&lt;ClientLongPolling&gt; iter = allSubs.iterator(); iter.hasNext(); ) &#123;</span><br><span class="line">                    ClientLongPolling clientSub = iter.next();</span><br><span class="line">                    <span class="keyword">if</span> (clientSub.clientMd5Map.containsKey(groupKey)) &#123;</span><br><span class="line">                        <span class="comment">// If published tag is not in the beta list, then it skipped.</span></span><br><span class="line">                        <span class="keyword">if</span> (isBeta &amp;&amp; !CollectionUtils.contains(betaIps, clientSub.ip)) &#123;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        </span><br><span class="line">                        <span class="comment">// If published tag is not in the tag list, then it skipped.</span></span><br><span class="line">                        <span class="keyword">if</span> (StringUtils.isNotBlank(tag) &amp;&amp; !tag.equals(clientSub.tag)) &#123;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        </span><br><span class="line">                        getRetainIps().put(clientSub.ip, System.currentTimeMillis());</span><br><span class="line">                        <span class="comment">// 这里也会单独删除订阅关系</span></span><br><span class="line">                        iter.remove(); </span><br><span class="line">                        LogUtil.CLIENT_LOG</span><br><span class="line">                                .info(<span class="string">&quot;&#123;&#125;|&#123;&#125;|&#123;&#125;|&#123;&#125;|&#123;&#125;|&#123;&#125;|&#123;&#125;&quot;</span>, (System.currentTimeMillis() - changeTime), <span class="string">&quot;in-advance&quot;</span>,</span><br><span class="line">                                        RequestUtil</span><br><span class="line">                                                .getRemoteIp((HttpServletRequest) clientSub.asyncContext.getRequest()),</span><br><span class="line">                                        <span class="string">&quot;polling&quot;</span>, clientSub.clientMd5Map.size(), clientSub.probeRequestSize, groupKey);</span><br><span class="line">                        clientSub.sendResponse(Arrays.asList(groupKey));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                LogUtil.DEFAULT_LOG.error(<span class="string">&quot;data change error: &#123;&#125;&quot;</span>, ExceptionUtil.getStackTrace(t));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">sendResponse</span><span class="params">(List&lt;String&gt; changedGroups)</span> </span>&#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Cancel time out task.</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != asyncTimeoutFuture) &#123;</span><br><span class="line">                asyncTimeoutFuture.cancel(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            generateResponse(changedGroups);</span><br><span class="line">   &#125;</span><br><span class="line">            </span><br></pre></td></tr></table></div></figure>
<p>该run方法有两个逻辑</p>
<ul>
<li><p>遍历 allSubs 的队列：首先遍历 allSubs 的队列，该队列中维持的是所有客户端的请求任务，需要找到与当前发生变更的配置项的 groupKey 相等的 ClientLongPolling 任务</p>
</li>
<li><p>往客户端写响应数据：在第一步找到具体的 ClientLongPolling 任务后，只需要将发生变更的 groupKey 通过该 ClientLongPolling 写入到响应对象中，就完成了一次数据变更的 “推送” 操作了</p>
</li>
</ul>
<p>如果 DataChangeTask 任务完成了数据的 “推送” 之后，ClientLongPolling 中的调度任务又开始执行了。这时只要在进行“推送”操作之前，先将原来等待执行的调度任务取消掉就可以了，这样就防止了推送操作写完响应数据之后，调度任务又去写响应数据，这时肯定会报错的。</p>

        <h4 id="小结">
          <a href="#小结" class="heading-link"><i class="fas fa-link"></i></a><a href="#小结" class="headerlink" title="小结"></a>小结</h4>
      <p>1、客户端的请求到达服务端后，服务端将该请求加入到一个叫 allSubs 的队列中，等待配置发生变更时 DataChangeTask 主动去触发，并将变更后的数据写入响应对象<br>2、与此同时服务端也将该请求封装成一个调度任务去执行，等待调度的期间就是等待 DataChangeTask 主动触发的，如果延迟时间到了 DataChangeTask 还未触发的话，则调度任务开始执行数据变更的检查，然后将检查的结果写入响应对象，如下图所示：<br>
        <img class="lazyload lazyload-gif" src="/images/loading.svg" data-src="nacosUpdate.png">
      <br>3、另外执行过程中，删除订阅关系一共有两条线路，一是在配置发生变更，主动触发的逻辑时，二是延时调度任务执行时</p>

        <h3 id="nacos动态配置怎么触发刷新-Refresh-Bean">
          <a href="#nacos动态配置怎么触发刷新-Refresh-Bean" class="heading-link"><i class="fas fa-link"></i></a><a href="#nacos动态配置怎么触发刷新-Refresh-Bean" class="headerlink" title="nacos动态配置怎么触发刷新@Refresh Bean"></a>nacos动态配置怎么触发刷新@Refresh Bean</h3>
      <p>在NacosContextRefresher的registerNacosListener中，在接受到有配置修改的情况下，会进行监听器通知，然后这里面会进行RefreshEvent事件的通知</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerNacosListener</span><span class="params">(<span class="keyword">final</span> String group, <span class="keyword">final</span> String dataId)</span> </span>&#123;</span><br><span class="line">      	<span class="comment">//放进listenerMap中，如果不存在的话就创建一个AbstractSharedListener并返回</span></span><br><span class="line">       Listener listener = (Listener)<span class="keyword">this</span>.listenerMap.computeIfAbsent(dataId, (i) -&gt; &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> Listener() &#123;</span><br><span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveConfigInfo</span><span class="params">(String configInfo)</span> </span>&#123;</span><br><span class="line">                   ...</span><br><span class="line">                   <span class="comment">// 发布一个spring refreshEvent事件 对应监听器为RefreshEventListener 该监听器会完成配置的更新应用</span></span><br><span class="line">                   NacosContextRefresher.<span class="keyword">this</span>.applicationContext.publishEvent(<span class="keyword">new</span> RefreshEvent(<span class="keyword">this</span>, (Object)<span class="keyword">null</span>, <span class="string">&quot;Refresh Nacos config&quot;</span>));</span><br><span class="line">               .   ...</span><br><span class="line">           &#125;;</span><br><span class="line">       &#125;);</span><br></pre></td></tr></table></div></figure>
<p>这里<code>RefreshEvent</code>事件对应的监听器为<code>RefreshEventListener</code>:</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">```java</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RefreshEventListener</span> <span class="keyword">implements</span> <span class="title">SmartApplicationListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Log log = LogFactory.getLog(RefreshEventListener.class);</span><br><span class="line">    <span class="keyword">private</span> ContextRefresher refresh;</span><br><span class="line">    <span class="keyword">private</span> AtomicBoolean ready = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationReadyEvent) &#123;</span><br><span class="line">            <span class="keyword">this</span>.handle((ApplicationReadyEvent)event);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (event <span class="keyword">instanceof</span> RefreshEvent) &#123;</span><br><span class="line">            <span class="keyword">this</span>.handle((RefreshEvent)event);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(ApplicationReadyEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.ready.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(RefreshEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.ready.get()) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;Event received &quot;</span> + event.getEventDesc());</span><br><span class="line">            Set&lt;String&gt; keys = <span class="keyword">this</span>.refresh.refresh();</span><br><span class="line">            log.info(<span class="string">&quot;Refresh keys changed: &quot;</span> + keys);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>从上文可以看到<code>this.refresh.refresh()</code>这里调用了ContextRefresher类对象refresh方法对@Refresh Bean对象刷新。</p>
<figure class="highlight java"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Set&lt;String&gt; <span class="title">refresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		Set&lt;String&gt; keys = refreshEnvironment();<span class="comment">//刷新环境属性源</span></span><br><span class="line">		<span class="keyword">this</span>.scope.refreshAll();<span class="comment">//刷新的地方</span></span><br><span class="line">		<span class="keyword">return</span> keys;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></div></figure>
<p>scope为RefreshScope对象。</p>

        <h3 id="是否需要开启自动刷新">
          <a href="#是否需要开启自动刷新" class="heading-link"><i class="fas fa-link"></i></a><a href="#是否需要开启自动刷新" class="headerlink" title="是否需要开启自动刷新"></a>是否需要开启自动刷新</h3>
      <p>服务是否需要自动更新配置，这个根据自身的业务去决定。在有灰度发布的场景，如果配置自动更新，再调整配置过后，那么全部实例都会生效，这样可能引发生产事故，随时被大佬约去喝茶；在没有灰度的场景下，可以配置自动更新，修改配置后不需要重启服务。</p>

        <h3 id="总结">
          <a href="#总结" class="heading-link"><i class="fas fa-link"></i></a><a href="#总结" class="headerlink" title="总结"></a>总结</h3>
      <ul>
<li>客户端是通过一个定时任务来检查自己监听的配置项的数据的，一旦服务端的数据发生变化时，客户端将会获取到最新的数据，并将最新的数据保存在一个 CacheData 对象中，然后会重新计算 CacheData 的 md5 属性的值，此时就会对该 CacheData 所绑定的 Listener 触发 receiveConfigInfo 回调，从而刷新@Refresh Bean对象。</li>
<li>Nacos 客户端会循环请求服务端变更的数据，并且超时时间设置为30s，当配置发生变化时，请求的响应会立即返回，否则会一直等到 29.5s+ 之后再返回响应。</li>
<li>Nacos 客户端能够实时感知到服务端配置发生了变化。</li>
<li>实时感知是建立在客户端拉和服务端“推”的基础上，因为服务端和客户端直接本质上还是通过http进行数据通讯的，之所以有“推”的感觉，是因为服务端主动将变更后的数据通过 http 的 response 对象提前写入了。</li>
</ul>

        <h3 id="参考资料">
          <a href="#参考资料" class="heading-link"><i class="fas fa-link"></i></a><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3>
      <ul>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://blog.csdn.net/sshduanzhijun/article/details/115327930">是时候抛弃 ConfigServer 了，试试 Nacos 统一配置中心动态刷新机制真香</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.cnblogs.com/reboot30/p/15133680.html">nacos-config 配置数据加载</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_33504929/article/details/112467996">nacos 配置动态刷新_你应该知道的 Nacos 接入和避坑指南</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/33VNgSn-8lHiRORaSdyFzg">Nacos或者Config是如何加载远程配置的？然后再模拟它造个轮子？</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://blog.csdn.net/wangwei19871103/article/details/105775039">Spring Cloud 2.2.2 源码之三十九nacos配置动态刷新原理一</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.jianshu.com/p/38b5452c9fec">Nacos 配置中心原理分析</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.jianshu.com/p/acb9b1093a54">Nacos 配置实时更新原理分析</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
<li><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.bbsmax.com/A/D854Nb7xzE">Spring Cloud Nacos实现动态配置加载的源码分析</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></li>
</ul>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="https://focusss.github.io">大湾区码仔驰名商标</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="https://focusss.github.io/2022/03/30/nacos-%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E6%9C%BA%E5%88%B6/">https://focusss.github.io/2022/03/30/nacos-%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E6%9C%BA%E5%88%B6/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://focusss.github.io/tags/nacos/">nacos</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2022/03/30/Spring-Cloud-Refersh%E5%8E%9F%E7%90%86/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">Spring Cloud @Refersh原理</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2022/03/26/SPI%E6%9C%BA%E5%88%B6/"><span class="paginator-prev__text">SPI机制</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#nacos-config%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E4%BD%BF%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">
          nacos config配置中心使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%95%E5%85%A5nacos-config-starter"><span class="toc-number">1.1.</span> <span class="toc-text">
          引入nacos config starter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-bootstrap%E5%92%8Capplication%E5%8C%BA%E5%88%AB"><span class="toc-number">1.2.</span> <span class="toc-text">
          配置文件 bootstrap和application区别</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E4%BD%8D%E7%BD%AE%E4%B8%8E%E9%A1%BA%E5%BA%8F"><span class="toc-number">1.2.1.</span> <span class="toc-text">
          配置文件加载位置与顺序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%95%B0%E6%8D%AE"><span class="toc-number">2.</span> <span class="toc-text">
          加载配置文件数据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nacos-config%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0%E6%9C%BA%E5%88%B6"><span class="toc-number">3.</span> <span class="toc-text">
          nacos config动态刷新机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.</span> <span class="toc-text">
          动态刷新配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">3.2.</span> <span class="toc-text">
          原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#nacos-config%E6%B3%A8%E5%86%8C%E7%9B%91%E5%90%AC%E5%99%A8-registerNacosListener"><span class="toc-number">3.2.1.</span> <span class="toc-text">
          nacos config注册监听器-registerNacosListener</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#nacos-config%E7%9B%91%E5%90%AC%E4%BA%8B%E4%BB%B6"><span class="toc-number">3.2.2.</span> <span class="toc-text">
          nacos config监听事件</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#nacos-config%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%A4%84%E7%90%86"><span class="toc-number">3.2.3.</span> <span class="toc-text">
          nacos config客户端处理</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#LongPollingRunnable"><span class="toc-number">3.2.3.1.</span> <span class="toc-text">
          LongPollingRunnable</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#CacheData%E4%B8%ADMD5%E5%80%BC%E4%BD%95%E6%97%B6%E6%9B%B4%E6%96%B0"><span class="toc-number">3.2.3.2.</span> <span class="toc-text">
          CacheData中MD5值何时更新</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#nacos-server%E5%A4%84%E7%90%86"><span class="toc-number">3.2.4.</span> <span class="toc-text">
          nacos server处理</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#ClientLongPolling%E5%BB%B6%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-number">3.2.4.1.</span> <span class="toc-text">
          ClientLongPolling延时任务</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%95%B0%E6%8D%AE%E5%8F%98%E6%9B%B4"><span class="toc-number">3.2.4.2.</span> <span class="toc-text">
          服务端数据变更</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-number">3.3.</span> <span class="toc-text">
          小结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nacos%E5%8A%A8%E6%80%81%E9%85%8D%E7%BD%AE%E6%80%8E%E4%B9%88%E8%A7%A6%E5%8F%91%E5%88%B7%E6%96%B0-Refresh-Bean"><span class="toc-number">4.</span> <span class="toc-text">
          nacos动态配置怎么触发刷新@Refresh Bean</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E5%BC%80%E5%90%AF%E8%87%AA%E5%8A%A8%E5%88%B7%E6%96%B0"><span class="toc-number">5.</span> <span class="toc-text">
          是否需要开启自动刷新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">6.</span> <span class="toc-text">
          总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">7.</span> <span class="toc-text">
          参考资料</span></a></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/headImg.jpg" alt="avatar"></div><p class="sidebar-ov-author__text">平安大赚 财丁兴旺</p></div><div class="sidebar-ov-social"><a class="sidebar-ov-social-item" href="https://github.com/" target="_blank" rel="noopener" data-popover="Github" data-popover-pos="up"><span class="sidebar-ov-social-item__icon"><i class="fab fa-github"></i></span></a></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">88</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--categories" href="/categories/"><div class="sidebar-ov-state-item__count">26</div><div class="sidebar-ov-state-item__name">分类</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">36</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2022</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>大湾区码仔驰名商标</span></div><div><span>由 <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a> 强力驱动</span><span> v5.4.0</span><span class="footer__devider">|</span><span>主题 - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div><div class="busuanzi"><span class="busuanzi-siteuv"><span class="busuanzi-siteuv__icon"><i class="fas fa-user"></i></span><span class="busuanzi-siteuv__info">访问人数</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_uv"></span></span><span class="busuanzi-sitepv"><span class="busuanzi-siteuv__icon"><i class="fas fa-eye"></i></span><span class="busuanzi-siteuv__info">浏览总量</span><span class="busuanzi-siteuv__value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><div class="search-mask"></div><div class="search-popup"><span class="search-close"></span><div class="search-input"><input placeholder="搜索文章（支持多关键词，请用空格分隔）"></div><div class="search-results"></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/ribbon.js@latest/dist/ribbon.min.js" size="120" alpha="0.6" zIndex="-1"></script><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-rc.2/lazyload.min.js"></script><script>function initSearch() {
  var isXML = true;
  var search_path = 'search.json';

  if (!search_path) {
    search_path = 'search.xml';
  } else if (/json$/i.test(search_path)) {
    isXML = false;
  }

  var path = '/' + search_path;
  $.ajax({
    url: path,
    dataType: isXML ? 'xml' : 'json',
    async: true,
    success: function (res) {
      var datas = isXML ? $('entry', res).map(function () {
        // 将 XML 转为 JSON
        return {
          title: $('title', this).text(),
          content: $('content', this).text(),
          url: $('url', this).text()
        };
      }).get() : res;
      var $input = $('.search-input input');
      var $result = $('.search-results');
      // 搜索对象（标题、内容）的权重，影响显示顺序
      var WEIGHT = { title: 100, content: 1 };
      var searchPost = function () {
        var searchText = $input.val().toLowerCase().trim();
        // 根据空白字符分隔关键字
        var keywords = searchText.split(/[\s]+/);
        // 搜索结果
        var matchPosts = [];

        // 有多个关键字时，将原文字整个保存下来
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        // 防止未输入字符时搜索
        if (searchText.length > 0) {
          datas.forEach(function (data) {
            var isMatch  = false;
            // 没有标题的文章使用预设的 i18n 变量代替
            var title = (data.title && data.title.trim()) || '[ 文章无标题 ]';
            var titleLower = title && title.toLowerCase();
            // 删除 HTML 标签 和 所有空白字符
            var content = data.content && data.content.replace(/<[^>]+>/g, '');
            var contentLower = content && content.toLowerCase();
            // 删除重复的 /
            var postURL = data.url && decodeURI(data.url).replace(/\/{2,}/g, '/');
            // 标题中匹配到的关键词
            var titleHitSlice = [];
            // 内容中匹配到的关键词
            var contentHitSlice = [];

            keywords.forEach(function (keyword) {
              /**
              * 获取匹配的关键词的索引
              * @param {String} keyword 要匹配的关键字
              * @param {String} text 原文字
              * @param {Boolean} caseSensitive 是否区分大小写
              * @param {Number} weight 匹配对象的权重。权重大的优先显示
              * @return {Array}
              */
              function getIndexByword (word, text, caseSensitive, weight) {
                if (!word || !text) {
                  return [];
                };

                var startIndex = 0; // 每次匹配的开始索引
                var index = -1;     // 匹配到的索引值
                var result = [];    // 匹配结果

                if (!caseSensitive) {
                  word = word.toLowerCase();
                  text = text.toLowerCase();
                }

                while((index = text.indexOf(word, startIndex)) !== -1) {
                  var hasMatch = false;
                  // 索引位置相同的关键词，保留长度较长的
                  titleHitSlice.forEach(function (hit) {
                    if (hit.index === index && hit.word.length < word.length) {
                      hit.word = word;
                      hasMatch = true;
                    }
                  });
                  startIndex = index + word.length;
                  !hasMatch && result.push({ index: index, word: word, weight: weight });
                }
                return result;
              }
              titleHitSlice = titleHitSlice.concat(getIndexByword(keyword, titleLower, false, WEIGHT.title));
              contentHitSlice = contentHitSlice.concat(getIndexByword(keyword, contentLower, false, WEIGHT.content));
            });

            var hitTitle = titleHitSlice.length;
            var hitContent = contentHitSlice.length;

            if (hitTitle > 0 || hitContent > 0) {
              isMatch = true;
            }
            if (isMatch) {
              ;[titleHitSlice, contentHitSlice].forEach(function (hit) {
                // 按照匹配文字的索引的递增顺序排序
                hit.sort(function (left, right) {
                  return left.index - right.index;
                });
              });
              /**
              * 给文本中匹配到的关键词添加标记，从而进行高亮显示
              * @param {String} text 原文本
              * @param {Array} hitSlice 匹配项的索引信息
              * @param {Number} start 开始索引
              * @param {Number} end 结束索引
              * @return {String}
              */
              function highlightKeyword (text, hitSlice, start, end) {
                if (!text || !hitSlice || !hitSlice.length) {
                  return;
                }

                var result = '';
                var startIndex = start;
                var endIndex = end;
                hitSlice.forEach(function (hit) {
                  if (hit.index < startIndex) {
                    return;
                  }

                  var hitWordEnd = hit.index + hit.word.length;
                  result += text.slice(startIndex, hit.index);
                  result += '<b>' + text.slice(hit.index, hitWordEnd) + '</b>';
                  startIndex = hitWordEnd;
                });
                result += text.slice(startIndex, endIndex);
                return result;
              }

              var postData = {};
              // 文章总的搜索权重
              var postWeight = titleHitSlice.length * WEIGHT.title + contentHitSlice.length * WEIGHT.content;
              // 标记匹配关键词后的标题
              var postTitle = highlightKeyword(title, titleHitSlice, 0, title.length) || title;
              // 标记匹配关键词后的内容
              var postContent;
              // 显示内容的长度
              var SHOW_WORD_LENGTH = 200;
              // 命中关键词前的字符显示长度
              var SHOW_WORD_FRONT_LENGTH = 20;
              var SHOW_WORD_END_LENGTH = SHOW_WORD_LENGTH - SHOW_WORD_FRONT_LENGTH;

              // 截取匹配的第一个字符，前后共 200 个字符来显示
              if (contentHitSlice.length > 0) {
                var firstIndex = contentHitSlice[0].index;
                var start = firstIndex > SHOW_WORD_FRONT_LENGTH ? firstIndex - SHOW_WORD_FRONT_LENGTH : 0;
                var end = firstIndex + SHOW_WORD_END_LENGTH;
                postContent = highlightKeyword(content, contentHitSlice, start, end);
              } else { // 未匹配到内容，直接截取前 200 个字符来显示
                postContent = content.slice(0, SHOW_WORD_LENGTH);
              }
              postData.title = postTitle;
              postData.content = postContent;
              postData.url = postURL;
              postData.weight = postWeight;
              matchPosts.push(postData);
            }
          });
        }

        var resultInnerHtml = '';
        if (matchPosts.length) {
          // 按权重递增的顺序排序，使权重大的优先显示
          matchPosts.sort(function (left, right) {
            return right.weight - left.weight;
          });
          resultInnerHtml += '<ul>';
          matchPosts.forEach(function (post) {
            resultInnerHtml += '<li><a class="search-results-title" href="' + post.url + '">';
            resultInnerHtml += post.title;
            resultInnerHtml += '</a><div class="search-results-content">';
            resultInnerHtml += post.content;
            resultInnerHtml += '</div></li>';
          });
          resultInnerHtml += '</ul>';
        } else {
          resultInnerHtml += '<div class="search-results-none"><i class="far fa-meh"></i></div>';
        }
        $result.html(resultInnerHtml);
      };
      $input.on('input', searchPost);
      $input.on('keyup', function (e) {
        if (e.keyCode === Stun.utils.codeToKeyCode('Enter')) {
          searchPost();
        }
      });
    }
  });
}

function closeSearch () {
  $('body').css({ overflow: 'auto' });
  $('.search-popup').css({ display: 'none' });
  $('.search-mask').css({ display: 'none' });
}

window.addEventListener('DOMContentLoaded', function () {
  Stun.utils.pjaxReloadLocalSearch = function () {
    $('.header-nav-search').on('click', function (e) {
      e.stopPropagation();
      $('body').css('overflow', 'hidden');
      $('.search-popup')
        .velocity('stop')
        .velocity('transition.expandIn', {
          duration: 300,
          complete: function () {
            $('.search-popup input').focus();
          }
        });
      $('.search-mask')
        .velocity('stop')
        .velocity('transition.fadeIn', {
          duration: 300
        });

      initSearch();
    });
    $('.search-mask, .search-close').on('click', function () {
      closeSearch();
    });
    $(document).on('keydown', function (e) {
      // Escape <=> 27
      if (e.keyCode === Stun.utils.codeToKeyCode('Escape')) {
        closeSearch();
      }
    });
  };

  Stun.utils.pjaxReloadLocalSearch();
}, false);

function safeOpenUrl(url) {
  var newTab = window.open();
  newTab.opener = null;
  newTab.location = url;
}

function extSearch(engine) {
  var engines = {
    google: 'https://www.google.com/search?q=',
    bing: 'https://cn.bing.com/search?q=',
    baidu: 'https://www.baidu.com/s?ie=UTF-8&wd=',
  };
  var host = window.location.host;
  var query = $('.search-input input').val().toLowerCase().trim();
  var uri = engines[engine] + query + ' site:' + host;

  if (query) {
    safeOpenUrl(uri);
  } else {
    Stun.utils.popAlert('warning', '请输入字符');
  }
}

var assistSearchList = window.CONFIG.assistSearch;

if (Array.isArray(assistSearchList)) {
  assistSearchList.forEach(function (name) {
    document.querySelector('.search-btns-item--' + name).addEventListener('click', function () {
      extSearch(name);
    }, false);
  });
}</script><script src="https://cdn.jsdelivr.net/npm/pjax@latest/pjax.min.js"></script><script>window.addEventListener('DOMContentLoaded', function () {
  var pjax = new Pjax({"selectors":["head title","#main",".pjax-reload"],"history":true,"scrollTo":false,"scrollRestoration":false,"cacheBust":false,"debug":false,"currentUrlFullReload":false,"timeout":0});
  // 加载进度条的计时器
  var loadingTimer = null;

  // 重置页面 Y 方向上的滚动偏移量
  document.addEventListener('pjax:send', function () {
    $('.header-nav-menu').removeClass('show');
    if (CONFIG.pjax && CONFIG.pjax.avoidBanner) {
      $('html').velocity('scroll', {
        duration: 500,
        offset: $('#header').height(),
        easing: 'easeInOutCubic'
      });
    }

    var loadingBarWidth = 20;
    var MAX_LOADING_WIDTH = 95;

    $('.loading-bar').addClass('loading');
    $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    clearInterval(loadingTimer);
    loadingTimer = setInterval(function () {
      loadingBarWidth += 3;
      if (loadingBarWidth > MAX_LOADING_WIDTH) {
        loadingBarWidth = MAX_LOADING_WIDTH;
      }
      $('.loading-bar__progress').css('width', loadingBarWidth + '%');
    }, 500);
  }, false);

  window.addEventListener('pjax:complete', function () {
    clearInterval(loadingTimer);
    $('.loading-bar__progress').css('width', '100%');
    $('.loading-bar').removeClass('loading');
    setTimeout(function () {
      $('.loading-bar__progress').css('width', '0');
    }, 400);
    $('link[rel=prefetch], script[data-pjax-rm]').each(function () {
      $(this).remove();
    });
    $('script[data-pjax], #pjax-reload script').each(function () {
      $(this).parent().append($(this).remove());
    });

    if (Stun.utils.pjaxReloadBoot) {
      Stun.utils.pjaxReloadBoot();
    }
    if (Stun.utils.pjaxReloadScroll) {
      Stun.utils.pjaxReloadScroll();
    }
    if (Stun.utils.pjaxReloadSidebar) {
      Stun.utils.pjaxReloadSidebar();
    }
    if (false) {
      if (Stun.utils.pjaxReloadHeader) {
        Stun.utils.pjaxReloadHeader();
      }
      if (Stun.utils.pjaxReloadScrollIcon) {
        Stun.utils.pjaxReloadScrollIcon();
      }
      if (Stun.utils.pjaxReloadLocalSearch) {
        Stun.utils.pjaxReloadLocalSearch();
      }
    }
  }, false);
}, false);</script><div id="pjax-reload"><script src="https://cdn.jsdelivr.net/gh/sukkaw/busuanzi@latest/bsz.pure.mini.js" async></script></div><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script><script type="application/json" src="/search.json"></script></body></html>